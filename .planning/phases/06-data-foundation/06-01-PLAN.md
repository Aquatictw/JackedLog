---
phase: 06-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/database/fivethreeone_blocks.dart
  - lib/database/database.dart
  - lib/fivethreeone/schemes.dart
  - lib/fivethreeone/fivethreeone_state.dart
  - lib/main.dart
autonomous: true

must_haves:
  truths:
    - "fivethreeone_blocks table exists in the database with columns for id, created, squat_tm, bench_tm, deadlift_tm, press_tm, unit, current_cycle, current_week, is_active, completed"
    - "Database migrates from v63 to v64 without data loss; existing tables and data are preserved"
    - "FiveThreeOneState ChangeNotifier is registered in the Provider tree and accessible via context.read<FiveThreeOneState>()"
    - "schemes.dart returns correct percentage/rep schemes for Leader 5's PRO, Anchor PR Sets, 7th Week Deload, TM Test, BBB supplemental, and FSL supplemental"
    - "schemes.dart has zero imports from package:flutter or database packages"
    - "Previous exported data from app can be reimported after schema change (new table is purely additive)"
  artifacts:
    - path: "lib/database/fivethreeone_blocks.dart"
      provides: "Drift table definition for FiveThreeOneBlocks"
      contains: "@DataClassName('FiveThreeOneBlock')"
    - path: "lib/database/database.dart"
      provides: "Table registration and v63->v64 migration"
      contains: "FiveThreeOneBlocks"
    - path: "lib/fivethreeone/schemes.dart"
      provides: "Pure percentage/rep scheme data for all cycle types"
      contains: "getMainScheme"
    - path: "lib/fivethreeone/fivethreeone_state.dart"
      provides: "ChangeNotifier for active block state"
      contains: "class FiveThreeOneState extends ChangeNotifier"
    - path: "lib/main.dart"
      provides: "Provider registration for FiveThreeOneState"
      contains: "FiveThreeOneState"
  key_links:
    - from: "lib/database/database.dart"
      to: "lib/database/fivethreeone_blocks.dart"
      via: "import and @DriftDatabase tables list"
      pattern: "FiveThreeOneBlocks"
    - from: "lib/fivethreeone/fivethreeone_state.dart"
      to: "lib/database/database.dart"
      via: "db.fiveThreeOneBlocks query"
      pattern: "db\\.fiveThreeOneBlocks"
    - from: "lib/main.dart"
      to: "lib/fivethreeone/fivethreeone_state.dart"
      via: "ChangeNotifierProvider in appProviders"
      pattern: "FiveThreeOneState"
---

<objective>
Create the complete data infrastructure for 5/3/1 Forever block programming: database table with migration, pure schemes data module, and state management with Provider registration.

Purpose: Phase 7-9 features (block management, calculator enhancement, block completion) all depend on this data foundation existing. Nothing can be built without the table, state class, and scheme data.

Output: 3 new files (table definition, schemes module, state class), 2 modified files (database.dart, main.dart). Database version bumped from 63 to 64.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-foundation/06-RESEARCH.md

Key source files to read before implementing:
@lib/database/database.dart — migration patterns, @DriftDatabase tables list, schemaVersion
@lib/database/notes.dart — table definition pattern with @DataClassName
@lib/database/bodyweight_entries.dart — simple table with unit text column
@lib/main.dart — appProviders() MultiProvider registration, db global
@lib/workouts/workout_state.dart — constructor async init with .catchError() pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fivethreeone_blocks table and database migration</name>
  <files>
    lib/database/fivethreeone_blocks.dart
    lib/database/database.dart
  </files>
  <action>
1. Create `lib/database/fivethreeone_blocks.dart` with Drift table definition:
   - Import `package:drift/drift.dart`
   - `@DataClassName('FiveThreeOneBlock')` annotation
   - `class FiveThreeOneBlocks extends Table` with columns:
     - `id` — `integer().autoIncrement()()`
     - `created` — `dateTime()()`
     - `squatTm` — `real()()`
     - `benchTm` — `real()()`
     - `deadliftTm` — `real()()`
     - `pressTm` — `real()()`
     - `unit` — `text()()`
     - `currentCycle` — `integer().withDefault(const Constant(0))()`
     - `currentWeek` — `integer().withDefault(const Constant(1))()`
     - `isActive` — `boolean().withDefault(const Constant(true))()`
     - `completed` — `dateTime().nullable()()`
   - Add comments on `currentCycle` explaining: 0=Leader1, 1=Leader2, 2=7th Week Deload, 3=Anchor, 4=TM Test
   - Add comment on `currentWeek` explaining: 1-3 within each cycle (7th Week cycles only use week 1)

2. Modify `lib/database/database.dart`:
   - Add import: `import 'fivethreeone_blocks.dart';`
   - Add `FiveThreeOneBlocks` to `@DriftDatabase(tables: [...])` list
   - Add migration block after the `from62To63` block (the last existing migration, around line 413):
     ```dart
     // from63To64: Add fivethreeone_blocks table for block programming
     if (from < 64 && to >= 64) {
       await m.database.customStatement('''
         CREATE TABLE IF NOT EXISTS fivethreeone_blocks (
           id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
           created INTEGER NOT NULL,
           squat_tm REAL NOT NULL,
           bench_tm REAL NOT NULL,
           deadlift_tm REAL NOT NULL,
           press_tm REAL NOT NULL,
           unit TEXT NOT NULL,
           current_cycle INTEGER NOT NULL DEFAULT 0,
           current_week INTEGER NOT NULL DEFAULT 1,
           is_active INTEGER NOT NULL DEFAULT 1,
           completed INTEGER
         )
       ''');
     }
     ```
   - Bump `schemaVersion` from 63 to 64

   CRITICAL: Migration SQL column types must match Drift mappings exactly:
   - DateTimeColumn -> INTEGER (not DATETIME)
   - BoolColumn -> INTEGER (not BOOLEAN)
   - RealColumn -> REAL
   - Column names must be snake_case matching Drift's camelCase-to-snake_case conversion

   NOTE: Do NOT use `.catchError((e) {})` on the CREATE TABLE statement. That pattern is only for ALTER TABLE where a column may already exist. Use `CREATE TABLE IF NOT EXISTS` instead for idempotency.

   BACKWARD COMPATIBILITY: This migration is purely additive (new table). It does not modify existing tables. CSV export/import only covers workouts and gym_sets tables — no changes needed. Database file import runs onUpgrade which handles version differences via CREATE TABLE IF NOT EXISTS.
  </action>
  <verify>
    - `lib/database/fivethreeone_blocks.dart` exists with @DataClassName('FiveThreeOneBlock') and all 11 columns
    - `lib/database/database.dart` imports fivethreeone_blocks.dart
    - FiveThreeOneBlocks appears in @DriftDatabase tables list
    - Migration block uses `from < 64 && to >= 64` guard
    - Migration SQL uses INTEGER for dateTime and boolean columns, REAL for TM columns
    - schemaVersion returns 64
    - No `.catchError()` on CREATE TABLE statement
  </verify>
  <done>
    fivethreeone_blocks table definition and v63->v64 migration exist in database.dart with correct column types and IF NOT EXISTS idempotency
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pure schemes.dart data module</name>
  <files>
    lib/fivethreeone/schemes.dart
  </files>
  <action>
1. Create directory `lib/fivethreeone/` if it does not exist.

2. Create `lib/fivethreeone/schemes.dart` with NO imports from `package:flutter/` or `database/` packages. This must be pure Dart.

Contents (all const where possible):

```dart
/// A single set prescription within a working set scheme
typedef SetScheme = ({double percentage, int reps, bool amrap});

/// Cycle type constants
const int cycleLeader1 = 0;
const int cycleLeader2 = 1;
const int cycleDeload = 2;
const int cycleAnchor = 3;
const int cycleTmTest = 4;

/// Human-readable cycle names
const List<String> cycleNames = [
  'Leader 1',
  'Leader 2',
  '7th Week Deload',
  'Anchor',
  'TM Test',
];

/// Number of weeks per cycle type
const List<int> cycleWeeks = [3, 3, 1, 3, 1];

/// Whether TM bumps after completing this cycle
const List<bool> cycleBumpsTm = [true, true, false, true, false];

/// Total weeks in a complete block
const int totalBlockWeeks = 11; // 3+3+1+3+1
```

Scheme data (all const maps/lists):
- `fivesProScheme` — Map<int, List<SetScheme>> for weeks 1-3, all sets x5 no AMRAP
  - Week 1: 65%x5, 75%x5, 85%x5
  - Week 2: 70%x5, 80%x5, 90%x5
  - Week 3: 75%x5, 85%x5, 95%x5
- `prSetsScheme` — Map<int, List<SetScheme>> for weeks 1-3, AMRAP on final set
  - Week 1: 65%x5, 75%x5, 85%x5+
  - Week 2: 70%x3, 80%x3, 90%x3+
  - Week 3: 75%x5, 85%x3, 95%x1+
- `deloadScheme` — List<SetScheme> single week: 70%x5, 80%x5, 90%x1, 100%x1
- `tmTestScheme` — List<SetScheme> single week: 70%x5, 80%x5, 90%x5, 100%x5
- `bbbScheme` — List<SetScheme> 5 sets of 60%x10

Functions:
- `getMainScheme({required int cycleType, required int week})` -> List<SetScheme>
  - cycleLeader1/cycleLeader2 -> fivesProScheme[week]
  - cycleAnchor -> prSetsScheme[week]
  - cycleDeload -> deloadScheme
  - cycleTmTest -> tmTestScheme
  - default -> empty list
- `getFslScheme({required int week})` -> List<SetScheme>
  - 5 sets x 5 reps at first working set percentage: week 1=65%, week 2=70%, week 3=75%
- `getSupplementalScheme({required int cycleType, required int week})` -> List<SetScheme>
  - cycleLeader1/cycleLeader2 -> bbbScheme
  - cycleAnchor -> getFslScheme(week)
  - cycleDeload/cycleTmTest -> empty list
  - default -> empty list
- `getSupplementalName(int cycleType)` -> String
  - cycleLeader1/cycleLeader2 -> 'BBB 5x10'
  - cycleAnchor -> 'FSL 5x5'
  - default -> ''

Use percentages as decimals (0.65 not 65). Use `switch` statements. Follow exact data from the research document.
  </action>
  <verify>
    - `lib/fivethreeone/schemes.dart` exists
    - File has ZERO imports from package:flutter or database packages
    - typedef SetScheme is defined as a record with percentage, reps, amrap
    - All 5 cycle type constants exist (0-4)
    - cycleNames, cycleWeeks, cycleBumpsTm lists have 5 elements each
    - fivesProScheme has 3 weeks, each with 3 sets
    - prSetsScheme has 3 weeks, AMRAP only on last set of each week
    - deloadScheme has 4 sets
    - tmTestScheme has 4 sets
    - bbbScheme has 5 sets at 60%
    - getMainScheme returns correct scheme per cycle type
    - getSupplementalScheme returns BBB for Leaders, FSL for Anchor, empty for Deload/TM Test
  </verify>
  <done>
    Pure schemes.dart module exists with all cycle type constants, scheme data, and getter functions — zero external dependencies
  </done>
</task>

<task type="auto">
  <name>Task 3: Create FiveThreeOneState and register in Provider tree</name>
  <files>
    lib/fivethreeone/fivethreeone_state.dart
    lib/main.dart
  </files>
  <action>
1. Create `lib/fivethreeone/fivethreeone_state.dart`:
   - Import `package:flutter/material.dart`
   - Import `'../database/database.dart'`
   - Import `'../main.dart'` (for `db` global)
   - Class `FiveThreeOneState extends ChangeNotifier` with:
     - Constructor that calls `_loadActiveBlock().catchError((error) { print('Warning: Error loading active 5/3/1 block: $error'); })` — matches WorkoutState pattern exactly
     - Private `FiveThreeOneBlock? _activeBlock` field
     - Public getter `FiveThreeOneBlock? get activeBlock => _activeBlock`
     - Public getter `bool get hasActiveBlock => _activeBlock != null`
     - Derived getter `int get currentCycle => _activeBlock?.currentCycle ?? 0`
     - Derived getter `int get currentWeek => _activeBlock?.currentWeek ?? 1`
     - Private `Future<void> _loadActiveBlock()` that queries:
       ```dart
       _activeBlock = await (db.fiveThreeOneBlocks.select()
             ..where((b) => b.isActive.equals(true))
             ..limit(1))
           .getSingleOrNull();
       notifyListeners();
       ```
     - Public `Future<void> refresh()` that calls `await _loadActiveBlock()`

   NOTE: Do NOT use stream watching (watchSingleOrNull). Block changes are user-initiated. Load on init, reload after mutations via refresh(). This matches WorkoutState pattern, NOT SettingsState stream pattern.

   NOTE: Use `db` global singleton from main.dart, NOT constructor injection. Matches all 5 existing state classes.

2. Modify `lib/main.dart`:
   - Add import: `import 'fivethreeone/fivethreeone_state.dart';`
   - Add to `appProviders()` MultiProvider list, after SpotifyState:
     `ChangeNotifierProvider(create: (context) => FiveThreeOneState()),`
   - Use same `create: (context) => ClassName()` factory pattern as existing providers
   - No `lazy: false` needed — default lazy creation is fine
  </action>
  <verify>
    - `lib/fivethreeone/fivethreeone_state.dart` exists
    - Class extends ChangeNotifier
    - Constructor calls _loadActiveBlock() with .catchError()
    - Uses db global (import from main.dart), NOT constructor injection
    - Uses getSingleOrNull() for nullable result
    - Has activeBlock, hasActiveBlock, currentCycle, currentWeek getters
    - Has refresh() public method
    - Does NOT use stream watching
    - `lib/main.dart` imports fivethreeone_state.dart
    - FiveThreeOneState appears in appProviders() MultiProvider list
  </verify>
  <done>
    FiveThreeOneState ChangeNotifier is created with constructor async init pattern and registered in Provider tree; accessible from any widget via context.read<FiveThreeOneState>()
  </done>
</task>

</tasks>

<verification>
After all 3 tasks complete:

1. File existence check:
   - `lib/database/fivethreeone_blocks.dart` exists
   - `lib/fivethreeone/schemes.dart` exists
   - `lib/fivethreeone/fivethreeone_state.dart` exists

2. Database integration check:
   - `database.dart` imports `fivethreeone_blocks.dart`
   - `FiveThreeOneBlocks` listed in `@DriftDatabase(tables: [...])`
   - Migration block with `from < 64 && to >= 64` guard exists
   - `schemaVersion => 64`

3. Provider integration check:
   - `main.dart` imports `fivethreeone_state.dart`
   - `FiveThreeOneState()` in `appProviders()` MultiProvider list

4. Schemes purity check:
   - `schemes.dart` has NO imports from `package:flutter/` or `../database/`

5. Backward compatibility:
   - Migration is purely additive (CREATE TABLE IF NOT EXISTS)
   - No existing tables modified
   - Previous exported data can be reimported (CSV only covers workouts/gym_sets; DB file import triggers onUpgrade)

NOTE: User must run `dart run build_runner build --delete-conflicting-outputs` after this plan completes to generate the Drift code (`database.g.dart`). Then `flutter analyze` to verify no compile errors.
</verification>

<success_criteria>
- All 3 new files created with correct content
- database.dart has table registration, import, migration SQL, and schemaVersion 64
- main.dart has FiveThreeOneState in Provider tree
- schemes.dart is pure Dart with zero external dependencies
- All code follows existing codebase conventions (naming, import order, error handling)
- No existing functionality broken
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-foundation/06-01-SUMMARY.md`
</output>
