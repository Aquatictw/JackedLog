---
phase: 04-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/import_data.dart
  - lib/import_hevy.dart
  - lib/backup/auto_backup_service.dart
  - lib/backup/auto_backup_settings.dart
autonomous: true

must_haves:
  truths:
    - "When import fails, console shows exception type, message, and file path"
    - "When import fails, user sees actionable toast (not generic 'Import failed: Exception')"
    - "When backup fails, console shows exception type and specific error context (permission, path, OS error)"
    - "When manual backup fails, user sees toast explaining what went wrong"
  artifacts:
    - path: "lib/import_data.dart"
      provides: "Enhanced error handling for database and workout imports"
      contains: "ERROR [Import"
    - path: "lib/import_hevy.dart"
      provides: "Enhanced error handling for Hevy imports"
      contains: "ERROR [ImportHevy]"
    - path: "lib/backup/auto_backup_service.dart"
      provides: "Enhanced logging for auto-backup failures"
      contains: "ERROR [AutoBackup]"
    - path: "lib/backup/auto_backup_settings.dart"
      provides: "User-friendly backup error messages"
      contains: "_getBackupErrorMessage"
  key_links:
    - from: "lib/import_data.dart"
      to: "lib/utils.dart"
      via: "toast() with actionable message"
      pattern: "toast\\(_getImport"
    - from: "lib/backup/auto_backup_settings.dart"
      to: "lib/utils.dart"
      via: "toast() with classified error message"
      pattern: "toast\\(_getBackup"
---

<objective>
Enhance error handling in import and backup operations to provide clear feedback to developers (console logs with context) and users (actionable toast messages).

Purpose: ERR-01 through ERR-04 requirements - make failures debuggable and user-friendly
Output: Enhanced catch blocks in 4 files with context-rich logging and actionable error messages
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-error-handling/04-RESEARCH.md

# Files to modify
@lib/import_data.dart
@lib/import_hevy.dart
@lib/backup/auto_backup_service.dart
@lib/backup/auto_backup_settings.dart
@lib/utils.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance import error handling (ERR-01, ERR-02)</name>
  <files>lib/import_data.dart, lib/import_hevy.dart</files>
  <action>
    In `import_data.dart`:

    1. In `importDatabase()` catch block (line 67-74):
       - Add context logging before toast:
         ```dart
         print('ERROR [ImportDatabase] Import failed');
         print('  File path: ${result?.files.single.path ?? 'unknown'}');
         print('  Exception type: ${e.runtimeType}');
         print('  Message: $e');
         if (e is FileSystemException) {
           print('  OS Error: ${e.osError}');
         }
         ```
       - Replace generic toast with: `toast(_getImportErrorMessage(e, result?.files.single.path), duration: const Duration(seconds: 10));`

    2. In `importWorkouts()` catch block (line 295-302):
       - Capture file path at start of try block: `String? filePath;` then `filePath = result.files.single.path;` after file picker
       - Add context logging:
         ```dart
         print('ERROR [ImportWorkouts] Import failed');
         print('  File path: $filePath');
         print('  Exception type: ${e.runtimeType}');
         print('  Message: $e');
         ```
       - Replace generic toast with: `toast(_getImportErrorMessage(e, filePath), duration: const Duration(seconds: 10));`

    3. Add helper function at end of ImportData class:
       ```dart
       String _getImportErrorMessage(Object error, String? filePath) {
         if (error is FormatException) {
           return 'Import failed: Invalid file format. Ensure this is a valid backup file.';
         }
         if (error is FileSystemException) {
           final osError = error.osError;
           if (osError != null) {
             if (osError.errorCode == 13) return 'Import failed: Storage permission denied.';
             if (osError.errorCode == 2) return 'Import failed: File not found.';
           }
           return 'Import failed: Could not read file.';
         }
         final msg = error.toString().toLowerCase();
         if (msg.contains('missing required csv')) {
           return 'Import failed: Invalid backup file (missing workouts or sets data).';
         }
         if (msg.contains('insufficient columns')) {
           return 'Import failed: Backup file format is outdated or corrupted.';
         }
         if (msg.contains('csv is empty')) {
           return 'Import failed: Backup file contains no data.';
         }
         final firstLine = error.toString().split('\n').first;
         return 'Import failed: ${firstLine.length > 80 ? '${firstLine.substring(0, 80)}...' : firstLine}';
       }
       ```

    4. Add `import 'dart:io';` if not present (for FileSystemException).

    In `import_hevy.dart`:

    1. In `_importHevy()` catch block (line 725-731):
       - Capture file path at start: `String? filePath;` then `filePath = result.files.single.path;` after picker
       - Add context logging:
         ```dart
         print('ERROR [ImportHevy] Import failed');
         print('  File path: $filePath');
         print('  Exception type: ${e.runtimeType}');
         print('  Message: $e');
         ```
       - Replace generic toast with: `toast(_getHevyImportErrorMessage(e, filePath), duration: const Duration(seconds: 10));`

    2. Add helper function at end of ImportHevy class:
       ```dart
       String _getHevyImportErrorMessage(Object error, String? filePath) {
         if (error is FormatException) {
           return 'Hevy import failed: Invalid CSV format.';
         }
         if (error is FileSystemException) {
           return 'Hevy import failed: Could not read file.';
         }
         final msg = error.toString().toLowerCase();
         if (msg.contains('could not find exercise column')) {
           return 'Hevy import failed: CSV missing exercise column. Is this a Hevy export file?';
         }
         if (msg.contains('csv file is empty') || msg.contains('at least one data row')) {
           return 'Hevy import failed: CSV file has no workout data.';
         }
         final firstLine = error.toString().split('\n').first;
         return 'Hevy import failed: ${firstLine.length > 80 ? '${firstLine.substring(0, 80)}...' : firstLine}';
       }
       ```
  </action>
  <verify>
    - `rg "ERROR \[Import" lib/` shows logging in import_data.dart and import_hevy.dart
    - `rg "_getImportErrorMessage\|_getHevyImportErrorMessage" lib/` shows helper functions exist
    - No syntax errors (user runs `flutter analyze`)
  </verify>
  <done>
    - Console logging with file path and exception type in all import catch blocks
    - User-friendly error messages mapping exception types to actionable descriptions
    - ERR-01 and ERR-02 satisfied
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance backup error handling (ERR-03, ERR-04)</name>
  <files>lib/backup/auto_backup_service.dart, lib/backup/auto_backup_settings.dart</files>
  <action>
    In `auto_backup_service.dart`:

    1. In `performAutoBackup()` catch block (line 55-58):
       - Replace silent `return false` with context logging:
         ```dart
         } catch (e) {
           print('ERROR [AutoBackup] Backup failed');
           print('  Exception type: ${e.runtimeType}');
           print('  Message: $e');
           if (e is FileSystemException) {
             print('  OS Error: ${e.osError}');
             print('  Path: ${e.path}');
           }
           if (e is PlatformException) {
             print('  Platform code: ${e.code}');
             print('  Platform message: ${e.message}');
           }
           return false;
         }
         ```

    2. Add imports at top if not present:
       - `import 'dart:io';` (for FileSystemException)
       - Already has `import 'package:flutter/services.dart';` (for PlatformException)

    In `auto_backup_settings.dart`:

    1. In `_performManualBackup()` catch block (line 442-445):
       - Add context logging before toast:
         ```dart
         print('ERROR [ManualBackup] Backup failed');
         print('  Backup path: $backupPath');
         print('  Exception type: ${e.runtimeType}');
         print('  Message: $e');
         if (e is FileSystemException) {
           print('  OS Error: ${e.osError}');
         }
         if (e is PlatformException) {
           print('  Platform code: ${e.code}');
           print('  Platform message: ${e.message}');
         }
         ```
       - Replace generic toast with: `toast(_getBackupErrorMessage(e), duration: const Duration(seconds: 10));`

    2. Add helper function in _AutoBackupSettingsState class:
       ```dart
       String _getBackupErrorMessage(Object error) {
         final msg = error.toString().toLowerCase();

         if (error is PlatformException) {
           final platformMsg = error.message?.toLowerCase() ?? '';
           if (platformMsg.contains('permission') || platformMsg.contains('denied')) {
             return 'Backup failed: Permission denied. Please re-select the backup folder.';
           }
           if (platformMsg.contains('no space') || platformMsg.contains('full')) {
             return 'Backup failed: Not enough storage space.';
           }
           return 'Backup failed: ${error.message ?? 'Unknown error'}';
         }

         if (error is FileSystemException) {
           final osError = error.osError;
           if (osError != null) {
             if (osError.errorCode == 13) return 'Backup failed: Permission denied.';
             if (osError.errorCode == 28) return 'Backup failed: Not enough storage space.';
             if (osError.errorCode == 2) return 'Backup failed: Folder not found. Please select a new backup folder.';
           }
           return 'Backup failed: Could not write to backup location.';
         }

         if (msg.contains('permission') || msg.contains('denied')) {
           return 'Backup failed: Permission denied. Please re-select the backup folder.';
         }
         if (msg.contains('no space') || msg.contains('disk full') || msg.contains('storage')) {
           return 'Backup failed: Not enough storage space.';
         }
         if (msg.contains('not found') || msg.contains('no such')) {
           return 'Backup failed: Backup folder not found. Please select a new folder.';
         }

         final firstLine = error.toString().split('\n').first;
         return 'Backup failed: ${firstLine.length > 80 ? '${firstLine.substring(0, 80)}...' : firstLine}';
       }
       ```

    3. Add `import 'dart:io';` at top if not present (for FileSystemException).
  </action>
  <verify>
    - `rg "ERROR \[AutoBackup\]\|ERROR \[ManualBackup\]" lib/backup/` shows logging in both files
    - `rg "_getBackupErrorMessage" lib/backup/` shows helper function in settings file
    - No syntax errors (user runs `flutter analyze`)
  </verify>
  <done>
    - Auto-backup logs errors with context (exception type, path, OS error details)
    - Manual backup shows user-friendly toast with actionable message
    - ERR-03 and ERR-04 satisfied
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Code verification:
   - `rg "ERROR \[" lib/` shows 4 locations: ImportDatabase, ImportWorkouts, ImportHevy, AutoBackup, ManualBackup
   - `rg "_get.*ErrorMessage" lib/` shows 3 helper functions

2. User runs `flutter analyze` to verify no syntax errors

3. Requirements traceability:
   - ERR-01: Import failures log exception type/context -> logging in import_data.dart and import_hevy.dart
   - ERR-02: Import failures show actionable toast -> _getImportErrorMessage and _getHevyImportErrorMessage
   - ERR-03: Backup failures log specific error reason -> logging in auto_backup_service.dart
   - ERR-04: Backup failures show toast to user -> _getBackupErrorMessage in auto_backup_settings.dart
</verification>

<success_criteria>
- All import catch blocks have context-rich logging (file path, exception type, message)
- All import errors show user-friendly toasts with actionable descriptions
- Auto-backup logs errors with specific context (permission, path, OS error)
- Manual backup shows classified error messages to user
- No regressions - existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling/04-01-SUMMARY.md`
</output>
