# Phase 9 Plan 1: Block Completion Summary

Block completion flow with post-block summary screen showing TM progression, block history viewing, and TM carry-over for new blocks.

## Changes Made

### Task 1: Schema Migration and State Methods
- Added 4 nullable `start_*_tm` columns to `fivethreeone_blocks` table for tracking starting TMs
- Added v64->v65 migration with ALTER TABLE + backfill of existing blocks
- Updated `createBlock()` to store starting TMs at block creation
- Added `getCompletedBlocks()` method returning completed blocks ordered by completion date desc
- Ran `build_runner` to regenerate `database.g.dart`

### Task 2: Block Summary Page and Completion Flow
- Created `BlockSummaryPage` StatelessWidget with date header, 4 lift progression cards (start -> end TM with signed delta badge), and Done button
- Rewrote `_CompleteWeekButton` to show "Complete Block" label on TM Test final week, captures block reference before advancing, navigates via pushReplacement to summary
- Added `_CompletedBlockHistory` widget using FutureBuilder with `getCompletedBlocks()` -- shown below active block timeline and in no-block view
- Tapping completed block card opens `BlockSummaryPage` for that block

### Task 3: Pre-fill New Block TMs
- Modified `_loadSettings()` in `BlockCreationDialog` to check completed blocks first, pre-filling TMs from the most recent completed block's ending TMs
- Falls back to Settings-based TMs when no completed blocks exist

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Start TMs nullable with fallback to current TM | Graceful handling of pre-migration blocks |
| Backfill migration sets start=current | Existing blocks get correct starting TMs retroactively |
| pushReplacement for block completion | Prevents back-navigating to completed block's overview |
| FutureBuilder for block history | Completed blocks are static data, no need for stream |

## Deviations from Plan

None -- plan executed exactly as written.

## Files Changed

### Created
- `lib/fivethreeone/block_summary_page.dart` -- Block completion summary with lift progression cards

### Modified
- `lib/database/fivethreeone_blocks.dart` -- Added 4 start TM columns
- `lib/database/database.dart` -- Schema v65, migration with backfill
- `lib/database/database.g.dart` -- Regenerated by build_runner
- `lib/fivethreeone/fivethreeone_state.dart` -- Start TMs in createBlock, getCompletedBlocks method
- `lib/fivethreeone/block_overview_page.dart` -- Completion flow, block history list
- `lib/fivethreeone/block_creation_dialog.dart` -- Pre-fill TMs from last completed block

## Metrics

- Duration: ~4 min
- Completed: 2026-02-11
