---
phase: 09-block-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/database/fivethreeone_blocks.dart
  - lib/database/database.dart
  - lib/fivethreeone/fivethreeone_state.dart
  - lib/fivethreeone/block_overview_page.dart
  - lib/fivethreeone/block_summary_page.dart
  - lib/fivethreeone/block_creation_dialog.dart
autonomous: true

must_haves:
  truths:
    - "Tapping 'Complete Week' on the final week of TM Test navigates to a summary screen showing starting TMs vs ending TMs for all 4 lifts with weight delta"
    - "Summary screen shows total weight gained per lift (e.g., '+6.6kg Squat')"
    - "After viewing summary, 'Done' button returns to notes page and block is marked complete"
    - "Completed blocks appear in block overview page history and can be tapped to revisit their summary"
    - "Starting a new block after a completed one pre-fills TMs from the last block's ending values"
  artifacts:
    - path: "lib/database/fivethreeone_blocks.dart"
      provides: "4 start_*_tm nullable columns in table definition"
      contains: "startSquatTm"
    - path: "lib/database/database.dart"
      provides: "Migration v64->v65 with ALTER TABLE and backfill"
      contains: "start_squat_tm"
    - path: "lib/fivethreeone/block_summary_page.dart"
      provides: "Post-block summary page showing TM progression"
      contains: "BlockSummaryPage"
    - path: "lib/fivethreeone/fivethreeone_state.dart"
      provides: "createBlock stores start TMs, getCompletedBlocks query"
      contains: "getCompletedBlocks"
    - path: "lib/fivethreeone/block_overview_page.dart"
      provides: "Block completion navigation to summary, completed block history list"
      contains: "BlockSummaryPage"
    - path: "lib/fivethreeone/block_creation_dialog.dart"
      provides: "TM pre-fill from last completed block"
      contains: "getCompletedBlocks"
  key_links:
    - from: "lib/fivethreeone/block_overview_page.dart"
      to: "lib/fivethreeone/block_summary_page.dart"
      via: "Navigator.pushReplacement on block completion"
      pattern: "pushReplacement.*BlockSummaryPage"
    - from: "lib/fivethreeone/fivethreeone_state.dart"
      to: "lib/database/fivethreeone_blocks.dart"
      via: "createBlock inserts start TM values"
      pattern: "startSquatTm.*Value"
    - from: "lib/fivethreeone/block_creation_dialog.dart"
      to: "lib/fivethreeone/fivethreeone_state.dart"
      via: "getCompletedBlocks for TM pre-fill"
      pattern: "getCompletedBlocks"
---

<objective>
Add post-block summary screen and block completion flow. When user taps "Complete Week" on the final week of TM Test, a summary page shows starting vs ending TMs for all 4 lifts with weight deltas. Completed blocks are listed as history on the overview page. New block creation pre-fills TMs from the last completed block.

Purpose: Users see meaningful progress feedback after completing an 11-week training block, and can seamlessly start the next one.
Output: Schema migration v65, BlockSummaryPage widget, modified completion flow, block history, TM pre-fill.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-block-completion/09-CONTEXT.md
@.planning/phases/09-block-completion/09-RESEARCH.md
@lib/database/fivethreeone_blocks.dart
@lib/database/database.dart
@lib/fivethreeone/fivethreeone_state.dart
@lib/fivethreeone/block_overview_page.dart
@lib/fivethreeone/block_creation_dialog.dart
@lib/fivethreeone/schemes.dart
@lib/notes/notes_page.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration and state methods for starting TMs and block history</name>
  <files>
    lib/database/fivethreeone_blocks.dart
    lib/database/database.dart
    lib/fivethreeone/fivethreeone_state.dart
  </files>
  <action>
1. **fivethreeone_blocks.dart** — Add 4 nullable start TM columns to the table definition:
   ```dart
   RealColumn get startSquatTm => real().nullable()();
   RealColumn get startBenchTm => real().nullable()();
   RealColumn get startDeadliftTm => real().nullable()();
   RealColumn get startPressTm => real().nullable()();
   ```

2. **database.dart** — Add migration v64->v65:
   - Bump `schemaVersion` from 64 to 65
   - Add migration block `if (from < 65 && to >= 65)` after the existing v64 block
   - Use `ALTER TABLE fivethreeone_blocks ADD COLUMN start_squat_tm REAL` (with `.catchError((e) {})` on each, matching existing pattern)
   - After all 4 ALTER TABLEs, run backfill: `UPDATE fivethreeone_blocks SET start_squat_tm = squat_tm, start_bench_tm = bench_tm, start_deadlift_tm = deadlift_tm, start_press_tm = press_tm`

3. **fivethreeone_state.dart** — Two changes:
   a. **createBlock()**: Add `startSquatTm: Value(squatTm)`, `startBenchTm: Value(benchTm)`, `startDeadliftTm: Value(deadliftTm)`, `startPressTm: Value(pressTm)` to the `FiveThreeOneBlocksCompanion.insert()` call. These snapshot the starting values at creation time.
   b. **getCompletedBlocks()**: Add a new public method:
   ```dart
   Future<List<FiveThreeOneBlock>> getCompletedBlocks() async {
     return (db.select(db.fiveThreeOneBlocks)
       ..where((b) => b.isActive.equals(false))
       ..where((b) => b.completed.isNotNull())
       ..orderBy([(b) => OrderingTerm(
           expression: b.completed, mode: OrderingMode.desc)]))
       .get();
   }
   ```

4. Run `dart run build_runner build --delete-conflicting-outputs` to regenerate `database.g.dart` with the new columns.

**CRITICAL:** The CLAUDE.md rule says "Always do manual migration" — use `customStatement` ALTER TABLEs, not Drift's auto-migration. The `build_runner` step is for regenerating the generated code after the table definition change, NOT for migration.
  </action>
  <verify>
  - Confirm `fivethreeone_blocks.dart` has 4 `start*Tm` column getters
  - Confirm `database.dart` has `schemaVersion => 65` and migration block with 4 ALTER TABLEs + backfill
  - Confirm `fivethreeone_state.dart` has `startSquatTm: Value(squatTm)` etc. in `createBlock()` and new `getCompletedBlocks()` method
  - Confirm `database.g.dart` was regenerated (contains `startSquatTm` field)
  </verify>
  <done>Schema has 4 start_tm columns with migration v65. createBlock stores starting TMs. getCompletedBlocks returns completed blocks ordered by completion date descending.</done>
</task>

<task type="auto">
  <name>Task 2: Block summary page, completion flow, and block history list</name>
  <files>
    lib/fivethreeone/block_summary_page.dart
    lib/fivethreeone/block_overview_page.dart
  </files>
  <action>
1. **block_summary_page.dart** (NEW) — Create `BlockSummaryPage` StatelessWidget:
   - Constructor takes `FiveThreeOneBlock block` parameter
   - Scaffold with AppBar title "Block Complete"
   - Body: `SingleChildScrollView` with padding, containing:
     - Header section: block dates (created -> completed) using `DateFormat` from intl package (already imported in notes_page.dart; check if available, otherwise use simple date toString)
     - 4 lift progression cards (one per exercise): each card shows exercise name, start TM -> end TM with unit, and a delta badge showing "+X.X unit" (or "-X.X" if somehow negative, or "+0.0" if unchanged)
     - Start TM uses `block.startSquatTm ?? block.squatTm` as fallback for pre-migration blocks
     - Delta calculation: `endTm - startTm` with sign prefix
     - Format TMs cleanly: show integer if whole number, one decimal otherwise
     - "Done" button: `FilledButton` with `Navigator.of(context).pop()` — full width, at bottom
   - Use Material 3 colorScheme for theming (match existing `_TmCard` styling patterns)
   - Lift cards: use `Card` with `Row` layout — exercise name + start->end text on left, delta badge on right (see research Pattern 3 code example)

2. **block_overview_page.dart** — Three changes:

   a. **Modify `_CompleteWeekButton`**: Replace the `isBlockComplete` static text block (lines 429-435) with a tappable "Complete Block" button that:
      - Captures `state.activeBlock!` reference BEFORE calling `advanceWeek()` (critical: after advance, activeBlock becomes null)
      - Calls `await state.advanceWeek()` to mark block inactive
      - If `context.mounted`, uses `Navigator.of(context).pushReplacement(MaterialPageRoute(builder: (_) => BlockSummaryPage(block: completedBlock)))` to show the summary
      - This replaces the overview page in the nav stack so "Done" pops cleanly to notes page
      - The button label should say "Complete Block" when `state.isBlockComplete` is true (which means we're on the TM Test final week)
      - NOTE: The `isBlockComplete` getter currently returns true when `currentCycle == cycleTmTest && currentWeek >= cycleWeeks[cycleTmTest]`. Since TM Test has 1 week and currentWeek starts at 1, this means `isBlockComplete` is true AS SOON AS we enter TM Test. The button should still be tappable (not static text). Restructure the build method: instead of an early return for `isBlockComplete`, make the button label conditional ("Complete Block" vs "Complete Week") and handle both paths in the onPressed handler.

   b. **Add completed block history** to the main `build()` method: Below the active block timeline (or in place of it when no active block), show a list of completed blocks using `FutureBuilder<List<FiveThreeOneBlock>>`:
      - Call `context.read<FiveThreeOneState>().getCompletedBlocks()` to get the data
      - Each completed block: compact card showing block dates, ending TMs summary, and tap to open `BlockSummaryPage` with that block
      - Add a "History" section header above the list if there are completed blocks
      - When no active block AND no completed blocks, show the existing "No active block" + Start button
      - When no active block but completed blocks exist, show the Start button at top then history below

   c. **Add import** for `block_summary_page.dart` at the top of the file.
  </action>
  <verify>
  - Confirm `block_summary_page.dart` exists with `BlockSummaryPage` class taking a `FiveThreeOneBlock block` parameter
  - Confirm `_CompleteWeekButton` shows a tappable button (not static text) when `isBlockComplete` is true, with label "Complete Block"
  - Confirm the completion handler captures block before `advanceWeek()` and uses `pushReplacement` to navigate to `BlockSummaryPage`
  - Confirm block history section uses `FutureBuilder` with `getCompletedBlocks()` and tapping a completed block opens `BlockSummaryPage`
  </verify>
  <done>Summary page shows 4 lift progression cards with start->end TMs and deltas. "Complete Block" button navigates to summary after marking block inactive. Completed blocks are listed in the overview page and tappable to revisit summaries.</done>
</task>

<task type="auto">
  <name>Task 3: Pre-fill new block TMs from last completed block</name>
  <files>
    lib/fivethreeone/block_creation_dialog.dart
  </files>
  <action>
1. **block_creation_dialog.dart** — Modify `_loadSettings()` to check for completed blocks FIRST:
   - Import `../database/database.dart` (for `db` access) and `../main.dart` (for `db` global)
   - In `_loadSettings()`, make the method `async` and add a try/catch around the new logic
   - First, call `context.read<FiveThreeOneState>().getCompletedBlocks()` to get completed blocks
   - If the list is not empty, take the first element (most recently completed) and use its ending TMs:
     ```dart
     final completedBlocks = await context.read<FiveThreeOneState>().getCompletedBlocks();
     if (completedBlocks.isNotEmpty) {
       final lastBlock = completedBlocks.first;
       _unit = lastBlock.unit;
       _squatController.text = _formatTm(lastBlock.squatTm);
       _benchController.text = _formatTm(lastBlock.benchTm);
       _deadliftController.text = _formatTm(lastBlock.deadliftTm);
       _pressController.text = _formatTm(lastBlock.pressTm);
       setState(() {});
       return;
     }
     ```
   - If no completed blocks, fall back to the existing Settings-based logic (current code)
   - Add a helper `_formatTm(double value)` that returns integer string if whole number, one decimal otherwise (same pattern as `_TmCardState._formatTm`)
   - Since `_loadSettings` is called from `initState` and is now async, wrap the async call: call it as `_loadSettings()` (fire-and-forget from initState is fine since it calls `setState` internally, matching the existing pattern where `_loadSettings` already calls `setState`)
  </action>
  <verify>
  - Confirm `_loadSettings()` checks `getCompletedBlocks()` first and uses the last completed block's ending TMs
  - Confirm fallback to Settings TMs when no completed blocks exist (existing behavior preserved)
  - Confirm `_formatTm` helper exists and formats cleanly
  </verify>
  <done>New block creation pre-fills TMs from the last completed block's ending values. Falls back to Settings TMs when no completed blocks exist.</done>
</task>

</tasks>

<verification>
1. Schema: `fivethreeone_blocks` table has `start_squat_tm`, `start_bench_tm`, `start_deadlift_tm`, `start_press_tm` columns
2. Migration: `database.dart` schemaVersion is 65 with proper v64->v65 migration including backfill
3. State: `createBlock()` stores starting TMs; `getCompletedBlocks()` returns completed blocks
4. Summary: `BlockSummaryPage` displays 4 lift cards with start->end TMs and signed delta
5. Completion: Tapping "Complete Block" on TM Test week captures block, advances, and navigates to summary via pushReplacement
6. History: Block overview page shows completed blocks below active block; tapping opens summary
7. Pre-fill: Block creation dialog loads TMs from last completed block when available
8. Navigation: "Done" on summary pops cleanly to notes page (no stale overview in stack)
</verification>

<success_criteria>
- User completes TM Test week -> sees summary with all 4 lift progressions and weight deltas
- Summary "Done" returns to notes page; block is now inactive
- Block overview shows completed block in history; tapping it shows the same summary
- Starting a new block pre-fills TMs from the completed block's ending values
- App does not crash on fresh install (migration handles new table creation) or upgrade (migration adds columns + backfills)
</success_criteria>

<output>
After completion, create `.planning/phases/09-block-completion/09-01-SUMMARY.md`
</output>
