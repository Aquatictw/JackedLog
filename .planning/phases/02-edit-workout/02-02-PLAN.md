---
phase: 02-edit-workout
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - lib/workouts/workout_detail_page.dart
autonomous: false

must_haves:
  truths:
    - "User can edit set weight and reps inline when in edit mode"
    - "User can add new sets to an exercise in edit mode"
    - "User can delete sets from an exercise in edit mode"
    - "User can change set type (working/warmup/dropset) in edit mode"
    - "User can access selfie feature from edit mode (not top bar)"
  artifacts:
    - path: "lib/workouts/workout_detail_page.dart"
      provides: "Set editing and selfie relocation"
      contains: "_buildEditableSetTile"
  key_links:
    - from: "lib/workouts/workout_detail_page.dart"
      to: "db.gymSets.update"
      via: "set weight/reps update"
      pattern: "gymSets\\.update.*weight|reps"
    - from: "lib/workouts/workout_detail_page.dart"
      to: "_editSelfie"
      via: "edit mode selfie button"
      pattern: "_editSelfie"
---

<objective>
Complete edit mode by adding inline set editing (weight, reps, type, add, delete) and relocating the selfie feature from top bar to edit mode panel.

Purpose: This completes the edit workout feature by allowing users to modify individual set data and access the selfie feature in a more logical location (grouped with other edit actions).

Output: Full edit mode functionality with inline set editing and selfie access from edit panel.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-edit-workout/02-CONTEXT.md
@.planning/phases/02-edit-workout/02-RESEARCH.md
@.planning/phases/02-edit-workout/02-01-SUMMARY.md

Key files to study:
@lib/workouts/workout_detail_page.dart (after Plan 01 modifications)
@lib/plan/exercise_sets_card.dart (for SetRow usage, _updateSet, _addSet, _deleteSet, _changeSetType patterns)
@lib/widgets/sets/set_row.dart (for inline editing UI reference)
@lib/models/set_data.dart (for SetData model)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement inline set editing in edit mode</name>
  <files>lib/workouts/workout_detail_page.dart</files>
  <action>
Add inline set editing capabilities when in edit mode:

1. Add imports at top (if not already present):
   - `import '../models/set_data.dart';`
   - `import '../widgets/sets/set_row.dart';`
   - `import '../records/records_service.dart';` (for clearPRCache)

2. Modify `_exerciseGroups` state to include SetData for editing:
   - Change type to: `List<({String name, int sequence, List<SetData> editableSets})>`
   - In `_enterEditMode()`, convert GymSet list to SetData list for each exercise:
     ```dart
     _exerciseGroups = exerciseGroups.map((g) => (
       name: g.name,
       sequence: g.minSeq,
       editableSets: g.sets.map((s) => SetData(
         weight: s.weight,
         reps: s.reps.toInt(),
         completed: !s.hidden,
         savedSetId: s.id,
         isWarmup: s.warmup,
         isDropSet: s.dropSet,
         records: _recordsMap[s.id] ?? {},
       )).toList(),
     )).toList();
     ```

3. Add set editing methods (pattern from ExerciseSetsCard lines 734-793):

   `_updateSetWeight(int exerciseIndex, int setIndex, double value)`:
   - Update local `_exerciseGroups[exerciseIndex].editableSets[setIndex].weight = value`
   - If set has savedSetId, update database: `db.gymSets.update()..where(id.equals(...))` with new weight
   - Call `clearPRCache()`
   - Set `_hasUnsavedChanges = true`

   `_updateSetReps(int exerciseIndex, int setIndex, int value)`:
   - Same pattern as weight update
   - Update reps field

   `_addSetToExercise(int exerciseIndex, {bool isWarmup = false, bool isDropSet = false})`:
   - Get exercise info from `_exerciseGroups[exerciseIndex]`
   - Calculate insertIndex (warmups at front, working in middle, dropsets at end)
   - Get default weight/reps from last set of same type or exercise defaults
   - Insert to database with workoutId, sequence, setOrder
   - Add to local `_exerciseGroups[exerciseIndex].editableSets`
   - Update setOrder for all sets in exercise
   - Set `_hasUnsavedChanges = true`
   - HapticFeedback.selectionClick()

   `_deleteSetFromExercise(int exerciseIndex, int setIndex)`:
   - Get set from `_exerciseGroups[exerciseIndex].editableSets[setIndex]`
   - If has savedSetId, delete from database
   - Remove from local list
   - Call `clearPRCache()`
   - Set `_hasUnsavedChanges = true`
   - HapticFeedback.mediumImpact()

   `_changeSetType(int exerciseIndex, int setIndex, bool isWarmup, bool isDropSet)`:
   - Update local set: `.isWarmup = isWarmup`, `.isDropSet = isDropSet`
   - If has savedSetId, update database warmup and dropSet fields
   - Set `_hasUnsavedChanges = true`
   - HapticFeedback.lightImpact()

4. Create `_buildEditableExerciseCard(int exerciseIndex)` widget method:
   - Returns a Card with exercise name header and list of editable sets
   - Header includes: exercise name, remove button (red X), expand/collapse toggle
   - For each set, use SetRow widget (or simplified inline version):
     - Weight input with +/- buttons
     - Reps input with +/- buttons
     - Set type indicator (warmup/working/dropset) - tappable to change via bottom sheet
     - Delete button (X icon)
     - Checkbox/toggle for completion status (optional - sets in completed workouts are typically all done)
   - Add set buttons row at bottom (Warmup / Working / Drop) - pattern from ExerciseSetsCard lines 1144-1286
   - Use ReorderableListView for sets within exercise (optional, for reordering sets)

5. In edit mode exercise list, replace read-only tiles with `_buildEditableExerciseCard(index)`.

Note: You can simplify by not using the full SetRow widget - create inline number inputs instead if SetRow is too complex to integrate. The key is that weight/reps are editable and set type can be changed.
  </action>
  <verify>Code compiles without errors. Check that _updateSetWeight, _updateSetReps, _addSetToExercise, _deleteSetFromExercise, _changeSetType methods exist. Check that SetData model is used.</verify>
  <done>User can edit set weight/reps inline. User can add warmup/working/drop sets. User can delete sets. User can change set type via tap.</done>
</task>

<task type="auto">
  <name>Task 2: Relocate selfie feature to edit mode</name>
  <files>lib/workouts/workout_detail_page.dart</files>
  <action>
Move selfie access from top bar to edit mode panel:

1. In normal (non-edit) mode app bar actions:
   - REMOVE the selfie IconButton (camera icon) from actions list
   - Keep: delete button
   - Keep: resume workout button (if workout ended)
   - Add: edit button (pencil icon) to enter edit mode

2. In edit mode app bar actions:
   - Add selfie IconButton (camera icon) that calls existing `_editSelfie(context)` method
   - Keep: save button (checkmark)
   - The close (X) is in leading position

3. Alternatively, add selfie button to a floating action area or bottom of edit panel:
   - Create a "Edit Actions" row at top of edit mode content showing:
     - Camera icon button for selfie
     - This provides clear access to the selfie feature when editing

4. The existing `_editSelfie(context)` method already handles:
   - Camera/gallery picker
   - Remove selfie option
   - Database update via `_updateSelfie` and `_removeSelfie`
   - No changes needed to these methods

5. Update visual feedback:
   - When in edit mode, if workout has selfie, show "Change Selfie" tooltip
   - If no selfie, show "Add Selfie" tooltip
  </action>
  <verify>Check that selfie button is NOT in app bar actions when NOT in edit mode. Check that selfie button IS accessible when in edit mode (either in app bar or in edit panel).</verify>
  <done>Selfie button removed from normal mode app bar. Selfie button accessible in edit mode. Selfie functionality unchanged.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete edit workout functionality: mode toggle, name editing, exercise management (add/remove/reorder), inline set editing (weight/reps/type/add/delete), and selfie relocation</what-built>
  <how-to-verify>
1. Open app and navigate to History tab
2. Tap on any completed workout to open detail page
3. Verify: Selfie button is NOT in top bar (only delete and edit buttons)
4. Tap pencil/edit button
5. Verify: App bar changes (shows close X, save checkmark, selfie camera icon)
6. Verify: Edit mode visual indicator visible (different accent color)
7. Tap workout name - verify rename dialog works
8. Test set editing:
   - Tap on weight field and change it
   - Tap on reps field and change it
   - Tap on set type indicator and change to warmup/dropset
   - Tap add warmup/working/drop button
   - Delete a set
9. Test exercise management:
   - Tap add exercise button, select an exercise
   - Drag exercises to reorder
   - Remove an exercise (confirm deletion)
10. Test selfie:
    - Tap camera icon in edit mode
    - Verify selfie options appear
11. Tap close (X) without saving - verify discard dialog appears
12. Make changes and tap save (checkmark) - verify changes persist
13. Exit and re-enter workout detail - verify all changes saved correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all edit features work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Full edit mode functionality:
1. Edit button enters edit mode with visual feedback
2. Workout name editable via tappable title
3. Exercises can be added, removed, and reordered
4. Sets can have weight/reps edited inline
5. Sets can be added (warmup/working/drop types)
6. Sets can be deleted
7. Set type can be changed
8. Selfie accessible from edit mode (not normal mode top bar)
9. Discard confirmation on exit with unsaved changes
10. Save persists all changes to database
11. PR cache cleared when weight/reps modified
</verification>

<success_criteria>
Requirements covered:
- EDIT-01: User can edit workout name - YES
- EDIT-02: User can add exercises - YES
- EDIT-03: User can remove exercises - YES
- EDIT-04: User can reorder exercises - YES
- EDIT-05: User can edit set weight/reps - YES
- EDIT-06: User can add sets - YES
- EDIT-07: User can delete sets - YES
- EDIT-08: User can change set type - YES
- EDIT-09: Selfie accessible from edit panel - YES
</success_criteria>

<output>
After completion, create `.planning/phases/02-edit-workout/02-02-SUMMARY.md`
</output>
