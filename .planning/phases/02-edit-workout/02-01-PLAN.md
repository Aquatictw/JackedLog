---
phase: 02-edit-workout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/workouts/workout_detail_page.dart
autonomous: true

must_haves:
  truths:
    - "User can tap edit button in app bar to enter edit mode"
    - "User can tap workout name in edit mode to rename it"
    - "User can add exercises to the workout via exercise picker"
    - "User can remove exercises from the workout"
    - "User can reorder exercises via drag-drop"
    - "User sees discard confirmation when leaving edit mode with unsaved changes"
  artifacts:
    - path: "lib/workouts/workout_detail_page.dart"
      provides: "Edit mode toggle and exercise management"
      contains: "_isEditMode"
  key_links:
    - from: "lib/workouts/workout_detail_page.dart"
      to: "ExercisePickerModal"
      via: "showModalBottomSheet import"
      pattern: "ExercisePickerModal"
    - from: "lib/workouts/workout_detail_page.dart"
      to: "db.workouts.update"
      via: "workout name save"
      pattern: "workouts\\.update.*name"
---

<objective>
Implement edit mode foundation for WorkoutDetailPage: mode toggle, workout rename, and exercise management (add, remove, reorder).

Purpose: This establishes the core edit mode infrastructure that all edit features build upon. Users can enter edit mode, rename workouts, and manage exercises.

Output: WorkoutDetailPage with functional edit mode toggle, tappable name editing, and exercise add/remove/reorder capabilities.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-edit-workout/02-CONTEXT.md
@.planning/phases/02-edit-workout/02-RESEARCH.md

Key files to study:
@lib/workouts/workout_detail_page.dart
@lib/plan/start_plan_page.dart (for _isReorderMode pattern, _editWorkoutTitle, _onReorder)
@lib/notes/note_editor_page.dart (for PopScope + discard confirmation pattern)
@lib/widgets/workout/exercise_picker_modal.dart (for adding exercises)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edit mode toggle and workout name editing</name>
  <files>lib/workouts/workout_detail_page.dart</files>
  <action>
Add edit mode state and infrastructure to _WorkoutDetailPageState:

1. Add state variables:
   - `bool _isEditMode = false` - controls edit/view mode
   - `bool _hasUnsavedChanges = false` - tracks if changes made
   - `String? _originalName` - stores original name for rollback

2. Add helper methods:
   - `_enterEditMode()`: Set `_isEditMode = true`, snapshot `_originalName = currentWorkout.name`
   - `_exitEditMode({bool save = false})`: If save, persist changes. If not save and `_hasUnsavedChanges`, show discard dialog. Reset `_isEditMode = false`
   - `_showDiscardDialog()`: AlertDialog asking "Discard changes?" with Cancel/Discard buttons (pattern from NoteEditorPage)

3. Wrap Scaffold with PopScope (pattern from NoteEditorPage lines 178-188):
   - `canPop: !_isEditMode || !_hasUnsavedChanges`
   - `onPopInvokedWithResult`: If in edit mode with changes, show discard dialog

4. Modify SliverAppBar when `_isEditMode`:
   - Change leading to close icon (X) that calls `_exitEditMode(save: false)`
   - Make title tappable to edit name (pattern from StartPlanPage lines 422-444):
     - GestureDetector wrapping title with edit icon
     - `_editWorkoutName()` method: TextField dialog, update via `db.workouts.update`, set `_hasUnsavedChanges = true`, call `_reloadWorkout()`
   - Add checkmark action button that calls `_exitEditMode(save: true)`
   - Hide selfie and resume buttons in edit mode (they move to edit panel in Plan 02)
   - Keep delete button visible

5. Add visual indicator for edit mode:
   - Change app bar background/accent color when editing (e.g., tertiaryContainer tint)
  </action>
  <verify>Code compiles without errors. Check that _isEditMode, _hasUnsavedChanges, _enterEditMode, _exitEditMode, _showDiscardDialog, and PopScope are present in the file.</verify>
  <done>Edit mode can be toggled via pencil button. Workout name is editable via tappable title. Discard confirmation appears when exiting with unsaved changes.</done>
</task>

<task type="auto">
  <name>Task 2: Add exercise management in edit mode</name>
  <files>lib/workouts/workout_detail_page.dart</files>
  <action>
Implement exercise add, remove, and reorder functionality when in edit mode:

1. Add imports at top:
   - `import '../widgets/workout/exercise_picker_modal.dart';`
   - `import 'package:flutter/services.dart';` (for HapticFeedback)

2. Add state for exercise management:
   - `List<({String name, int sequence, List<GymSet> sets})> _exerciseGroups = []` - local copy of exercises for editing
   - Populate in `_enterEditMode()` from the existing exerciseGroups built in StreamBuilder

3. Add exercise management methods:

   `_addExercise()`:
   - Show ExercisePickerModal via showModalBottomSheet (pattern from StartPlanPage lines 799-821)
   - On result, calculate next sequence number
   - Insert placeholder set to database: `db.gymSets.insertReturning(...)` with:
     - name: selected exercise
     - sequence: next sequence
     - workoutId: widget.workout.id
     - hidden: false (completed workout)
     - setOrder: 0
   - Add to local `_exerciseGroups` list
   - Set `_hasUnsavedChanges = true`

   `_removeExercise(int index)`:
   - Show confirmation dialog ("Remove {exerciseName} and all its sets?")
   - On confirm, delete from database: `db.gymSets.delete()..where(s.workoutId.equals(...) & s.name.equals(...) & s.sequence.equals(...))`
   - Update sequence numbers for exercises after removed one (decrement by 1)
   - Remove from local `_exerciseGroups`
   - Check superset consistency with `_checkAndUnmarkSingleSuperset` if exercise was in superset (copy pattern from StartPlanPage lines 296-320)
   - Call `clearPRCache()` (import from records_service.dart)
   - Set `_hasUnsavedChanges = true`

   `_reorderExercises(int oldIndex, int newIndex)`:
   - Adjust newIndex if moving down (if oldIndex < newIndex, newIndex--)
   - Reorder local `_exerciseGroups` list
   - Update sequence numbers in database for all exercises (pattern from StartPlanPage lines 243-288)
   - HapticFeedback.mediumImpact()
   - Set `_hasUnsavedChanges = true`

4. Modify exercise list rendering when `_isEditMode`:
   - Use ReorderableListView.builder instead of SliverList for exercises
   - Add drag handle to each exercise tile
   - Add "Remove" action (red X or trash icon) to each exercise
   - Add "Add Exercise" card/button at end of list (pattern from AddExerciseCard)

5. When NOT in edit mode, keep existing read-only display.
  </action>
  <verify>Code compiles without errors. Check that _addExercise, _removeExercise, _reorderExercises methods exist. Check that ExercisePickerModal import is present. Check that ReorderableListView is used when _isEditMode.</verify>
  <done>User can add exercises via picker modal. User can remove exercises with confirmation. User can drag-reorder exercises with haptic feedback. All changes update database and set unsaved flag.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Open the app and navigate to a completed workout detail page
2. Verify pencil/edit button appears in app bar
3. Tap edit button - verify UI transforms to edit mode (different accent, close/save buttons)
4. Tap workout name - verify rename dialog appears and works
5. Try to navigate back with changes - verify discard dialog appears
6. Add an exercise - verify picker appears and exercise is added
7. Remove an exercise - verify confirmation and exercise is removed
8. Drag exercises to reorder - verify haptic feedback and order persists
9. Tap checkmark to save - verify mode returns to read-only
</verification>

<success_criteria>
- Edit mode togglable via pencil icon in app bar
- Workout name editable via tappable title in edit mode
- Exercises can be added via ExercisePickerModal
- Exercises can be removed with confirmation dialog
- Exercises can be reordered via drag-drop with haptic feedback
- Discard confirmation appears when leaving edit mode with unsaved changes
- All database updates happen correctly (sequence numbers, PR cache cleared)
- App bar visual indicator shows when in edit mode
</success_criteria>

<output>
After completion, create `.planning/phases/02-edit-workout/02-01-SUMMARY.md`
</output>
