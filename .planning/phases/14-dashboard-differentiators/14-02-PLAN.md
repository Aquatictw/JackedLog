---
phase: 14-dashboard-differentiators
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - server/lib/services/dashboard_service.dart
  - server/lib/api/dashboard_pages.dart
  - server/bin/server.dart
autonomous: true

must_haves:
  truths:
    - "User can navigate to Bodyweight page from sidebar"
    - "Bodyweight page shows line chart with weight entries over time and gradient fill below"
    - "Period selector (7D/1M/3M/6M/1Y/All) filters the displayed data via page reload"
    - "Moving average toggle buttons (3-day, 7-day, 14-day) show/hide dashed overlay lines on the chart"
    - "Stats cards show Current weight, Average, Change, and Entries count"
    - "Entry history list below chart shows individual weight entries with date"
    - "Page shows 'No bodyweight data' message if table is missing or no entries exist"
  artifacts:
    - path: "server/lib/services/dashboard_service.dart"
      provides: "getBodyweightData() query method with period filtering and moving average computation"
      contains: "getBodyweightData"
    - path: "server/lib/api/dashboard_pages.dart"
      provides: "bodyweightPageHandler and Bodyweight nav item"
      contains: "bodyweightPageHandler"
    - path: "server/bin/server.dart"
      provides: "/dashboard/bodyweight route"
      contains: "dashboard/bodyweight"
  key_links:
    - from: "server/lib/api/dashboard_pages.dart"
      to: "server/lib/services/dashboard_service.dart"
      via: "dashboardService.getBodyweightData()"
      pattern: "dashboardService\\.getBodyweightData"
    - from: "server/bin/server.dart"
      to: "server/lib/api/dashboard_pages.dart"
      via: "bodyweightPageHandler route registration"
      pattern: "bodyweightPageHandler"
    - from: "server/lib/api/dashboard_pages.dart"
      to: "dashboardShell navItem"
      via: "Bodyweight nav item in sidebar"
      pattern: "navItem.*Bodyweight"
---

<objective>
Add bodyweight trend page to the web dashboard showing weight entries over time with moving averages, period selector, and stats cards.

Purpose: DASH-12 requirement -- users can view their bodyweight trends, moving averages, and stats on the web dashboard, replicating the app's BodyweightOverviewPage.
Output: Working /dashboard/bodyweight page with line chart, MA toggles, period selector, stats cards, and entry history.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-differentiators/14-CONTEXT.md
@.planning/phases/14-dashboard-differentiators/14-RESEARCH.md
@.planning/phases/14-dashboard-differentiators/14-01-SUMMARY.md
@server/lib/services/dashboard_service.dart
@server/lib/api/dashboard_pages.dart
@server/bin/server.dart
@lib/utils/bodyweight_calculations.dart (moving average algorithm reference)
@lib/database/bodyweight_entries.dart (table schema reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getBodyweightData() query and bodyweightPageHandler</name>
  <files>
    server/lib/services/dashboard_service.dart
    server/lib/api/dashboard_pages.dart
  </files>
  <action>
**1. DashboardService.getBodyweightData()** in `dashboard_service.dart`:

Add a `getBodyweightData({String? period})` method that returns `Map<String, dynamic>` with keys: `entries`, `stats`, `ma3`, `ma7`, `ma14`.

Implementation:
- Return empty result if `_db` is null
- Check table existence: `SELECT name FROM sqlite_master WHERE type='table' AND name='bodyweight_entries'` -- if missing, return empty result
- CRITICAL: Bodyweight `date` column uses Drift's `DateTimeColumn` which stores as **integer seconds since epoch** (same as other Drift DateTimeColumns in this project). Verify by checking existing `_periodToEpoch()` which returns seconds.
- Query entries with period filter:
  ```sql
  SELECT id, weight, unit, date, notes
  FROM bodyweight_entries
  WHERE date >= ?
  ORDER BY date ASC
  ```
  Pass `_periodToEpoch(period)` as the parameter (this returns epoch seconds, matching Drift's storage format).

  For the period parameter, map incoming values: `'7d'` -> `'week'`, `'1m'` -> `'month'`, `'3m'` -> `'3m'`, `'6m'` -> `'6m'`, `'1y'` -> `'year'`, `'all'` -> `'all'` (or null). Create a small helper or do inline mapping before calling `_periodToEpoch()`. The existing `_periodToEpoch` already handles `'week'`, `'month'`, `'3m'`, `'6m'`, `'year'`, `'all'`.

- Map rows to list of `Map<String, dynamic>` with keys: `id`, `weight` (double), `unit`, `date` (int, epoch seconds), `notes`

- Calculate stats:
  - `current`: last entry's weight
  - `average`: mean of all weights (1 decimal)
  - `change`: last weight minus first weight (null if < 2 entries)
  - `entries`: count of entries
  - `unit`: last entry's unit

- **Compute moving averages server-side** (port from `bodyweight_calculations.dart`):
  Add a private helper `_calculateMovingAverage(List<Map<String, dynamic>> entries, int windowDays)` that returns `List<double?>`:
  - For each entry, define window: `currentDate.subtract(Duration(days: windowDays - 1))` to `currentDate`
  - Average all entries within that window
  - Uses calendar-day trailing window, NOT entry-count window
  - Convert `date` (epoch seconds) to DateTime: `DateTime.fromMillisecondsSinceEpoch(date * 1000)`

  Compute 3 lists: `ma3` (3-day), `ma7` (7-day), `ma14` (14-day).

- Return:
  ```dart
  {
    'entries': entries,
    'stats': stats,
    'ma3': ma3,
    'ma7': ma7,
    'ma14': ma14,
  }
  ```

**2. bodyweightPageHandler()** in `dashboard_pages.dart`:

Add function:
```dart
Response bodyweightPageHandler(
  Request request,
  DashboardService dashboardService,
  String apiKey,
)
```

Follow the exact same pattern as other page handlers (open DB, handle no data case).

Read `period` from query parameter: `request.url.queryParameters['period'] ?? 'all'`.
Map period values for the service: `'7d'` stays as `'7d'` etc. -- actually, update `_periodToEpoch` or add a small mapping in `getBodyweightData` to handle the `'7d'` -> `'week'` translation (or just add `'7d'` as a case in `_periodToEpoch` alongside `'week'`). The cleanest approach: **add `'7d'` as an alias for `'week'` and `'1m'` as alias for `'month'` and `'1y'` as alias for `'year'` in `_periodToEpoch()`**, so the same method handles both URL param styles.

Call `dashboardService.getBodyweightData(period: period)`.

**Build the page content:**

**A. Period selector** (same pattern as exercise detail page):
Period options: `('7d', '7D'), ('1m', '1M'), ('3m', '3M'), ('6m', '6M'), ('1y', '1Y'), ('all', 'All')`.
Each is a link to `/dashboard/bodyweight?key=$apiKey&period=$value`.
Active period gets accent background.

**B. Stats cards** (4-card grid, same style as overview page):
- Current: last weight + unit (e.g., "82.5 kg")
- Average: mean weight + unit
- Change: delta with + or - prefix, colored green (loss or gain depending on preference -- use green for ANY change with +/-, no judgment). Show "--" if < 2 entries.
- Entries: count

**C. Moving average toggle buttons:**
Below the period selector, 3 toggle buttons: "3-Day MA", "7-Day MA", "14-Day MA".
Style: outlined buttons (`background:var(--surface)`, `border:1px solid var(--border)`).
When active, add a colored left border or background tint matching the MA line color.
Each button calls `toggleMA(datasetIndex)` where indices are: 1 (14-day, cyan `#06B6D4`), 2 (7-day, green `#10B981`), 3 (3-day, amber `#F59E0B`).

**D. Bodyweight line chart** (Chart.js):
- Canvas element in a card container
- Embed chart data as JSON: `{ dates: [...], weights: [...], ma3: [...], ma7: [...], ma14: [...] }`
  - `dates`: formatted as "MMM D" (e.g., "Jan 5") for display labels
  - `weights`: raw weight values
  - `ma3`/`ma7`/`ma14`: moving average arrays (null values become `null` in JSON, Chart.js handles gaps)
- Datasets:
  1. Bodyweight: `borderColor: '#7C3AED'`, `borderWidth: 3`, `tension: 0.35`, `pointRadius: 4`, `pointBackgroundColor: '#7C3AED'`, `fill: 'origin'` with gradient background (same callback pattern as exercise detail chart -- use `chartArea` check for gradient)
  2. 14-Day MA: `borderColor: '#06B6D4'`, `borderDash: [5,5]`, `borderWidth: 2`, `pointRadius: 0`, `fill: false`, `hidden: true`
  3. 7-Day MA: `borderColor: '#10B981'`, same dashed style, `hidden: true`
  4. 3-Day MA: `borderColor: '#F59E0B'`, same dashed style, `hidden: true`
- Chart options: no legend display (custom toggle buttons instead), `maxTicksLimit: 8` on x-axis, grid only on y-axis
- `toggleMA(datasetIndex)` function using `chart.setDatasetVisibility(index, meta.hidden)` + `chart.update()`, plus toggle button visual state (add/remove `.active` class or toggle inline style)

**E. Entry history list** below chart:
Render each entry as a simple row in a card:
- Date (formatted "MMM D, YYYY"), weight + unit, notes (if any, muted italic)
- Most recent entries first (reverse of chart order)
- If many entries, this is fine as a scrollable list (no pagination needed for bodyweight -- typically dozens not thousands)

**F. Nav item in dashboardShell():**
Add a new nav item after "5/3/1 Blocks" (which was added in Plan 01):
```dart
${navItem('Bodyweight', '/dashboard/bodyweight', '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="5" r="3"/><path d="M3 14c0-3 2-5 5-5s5 2 5 5z"/></svg>')}
```
(Person icon representing body/weight tracking.)

**G. Include Chart.js CDN** in `extraHead` only when entries exist. Put toggle and chart scripts in `extraScripts`.
  </action>
  <verify>
    Grep for `getBodyweightData` in dashboard_service.dart and `bodyweightPageHandler` in dashboard_pages.dart. Grep for `Bodyweight` in dashboardShell nav section. Grep for `_calculateMovingAverage` in dashboard_service.dart. Grep for `toggleMA` in dashboard_pages.dart.
  </verify>
  <done>
    - getBodyweightData() method exists with table existence check, period filtering, stats calculation, and 3 moving average computations
    - _calculateMovingAverage() private helper uses calendar-day trailing window (ported from bodyweight_calculations.dart)
    - bodyweightPageHandler returns full HTML page with period selector, stats cards, MA toggle buttons, line chart with gradient fill, and entry history list
    - "Bodyweight" nav item added to dashboardShell() sidebar after 5/3/1 Blocks
  </done>
</task>

<task type="auto">
  <name>Task 2: Register /dashboard/bodyweight route in server.dart</name>
  <files>
    server/bin/server.dart
  </files>
  <action>
Add route in `server.dart` after the `/dashboard/blocks` route (added in Plan 01):

```dart
router.get('/dashboard/bodyweight',
    (req) => bodyweightPageHandler(req, dashboardService, config.apiKey));
```

Also update `_periodToEpoch()` in `dashboard_service.dart` to handle the URL-style period aliases if not already done in Task 1:
- Add cases `'7d'` (same as `'week'`), `'1m'` (same as `'month'`), `'1y'` (same as `'year'`) to the switch statement.
  </action>
  <verify>
    Grep for `dashboard/bodyweight` in server.dart. Grep for `'7d'` in `_periodToEpoch` in dashboard_service.dart.
  </verify>
  <done>
    - /dashboard/bodyweight route registered and wired to bodyweightPageHandler
    - _periodToEpoch handles 7d/1m/1y aliases
  </done>
</task>

</tasks>

<verification>
1. `rg 'getBodyweightData' server/lib/services/dashboard_service.dart` finds the method
2. `rg '_calculateMovingAverage' server/lib/services/dashboard_service.dart` finds the helper
3. `rg 'bodyweightPageHandler' server/lib/api/dashboard_pages.dart` finds the handler
4. `rg 'bodyweightPageHandler' server/bin/server.dart` finds the route
5. `rg 'Bodyweight' server/lib/api/dashboard_pages.dart` finds the nav item
6. `rg 'sqlite_master.*bodyweight_entries' server/lib/services/dashboard_service.dart` confirms table existence check
7. `rg "toggleMA" server/lib/api/dashboard_pages.dart` confirms MA toggle function
8. `rg "'7d'" server/lib/services/dashboard_service.dart` confirms period alias support
</verification>

<success_criteria>
- /dashboard/bodyweight page renders bodyweight entries as a line chart with gradient fill
- Period selector (7D/1M/3M/6M/1Y/All) reloads page with filtered data
- 3 moving average toggle buttons show/hide dashed overlay lines on the chart
- Stats cards display Current, Average, Change, and Entries count
- Entry history list shows individual entries below the chart
- "Bodyweight" appears in sidebar navigation on all dashboard pages
- Page gracefully handles missing table (old backups) and empty data
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-differentiators/14-02-SUMMARY.md`
</output>
