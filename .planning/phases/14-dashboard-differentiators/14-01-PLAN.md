---
phase: 14-dashboard-differentiators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/lib/services/dashboard_service.dart
  - server/lib/api/dashboard_pages.dart
  - server/bin/server.dart
autonomous: true

must_haves:
  truths:
    - "User can navigate to 5/3/1 Blocks page from sidebar"
    - "5/3/1 Blocks page shows completed block cards with date range and end TM values for all 4 lifts"
    - "Clicking a block card expands inline to show per-lift TM progression (start to end) with delta badges and cycle structure labels"
    - "TM progression grouped bar chart shows end TMs per block for all 4 lifts"
    - "Page shows 'No 5/3/1 data' message if table is missing or no completed blocks exist"
  artifacts:
    - path: "server/lib/services/dashboard_service.dart"
      provides: "getCompletedBlocks() query method"
      contains: "getCompletedBlocks"
    - path: "server/lib/api/dashboard_pages.dart"
      provides: "blockHistoryPageHandler and 5/3/1 Blocks nav item"
      contains: "blockHistoryPageHandler"
    - path: "server/bin/server.dart"
      provides: "/dashboard/blocks route"
      contains: "dashboard/blocks"
  key_links:
    - from: "server/lib/api/dashboard_pages.dart"
      to: "server/lib/services/dashboard_service.dart"
      via: "dashboardService.getCompletedBlocks()"
      pattern: "dashboardService\\.getCompletedBlocks"
    - from: "server/bin/server.dart"
      to: "server/lib/api/dashboard_pages.dart"
      via: "blockHistoryPageHandler route registration"
      pattern: "blockHistoryPageHandler"
    - from: "server/lib/api/dashboard_pages.dart"
      to: "dashboardShell navItem"
      via: "5/3/1 Blocks nav item in sidebar"
      pattern: "navItem.*Blocks"
---

<objective>
Add 5/3/1 block history page to the web dashboard showing completed blocks with expandable cards and TM progression chart.

Purpose: DASH-11 requirement -- users can view their 5/3/1 training history and TM progression over time on the web dashboard.
Output: Working /dashboard/blocks page with block cards, inline expand/collapse detail, and grouped bar chart.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-differentiators/14-CONTEXT.md
@.planning/phases/14-dashboard-differentiators/14-RESEARCH.md
@server/lib/services/dashboard_service.dart
@server/lib/api/dashboard_pages.dart
@server/bin/server.dart
@lib/fivethreeone/schemes.dart (cycleNames reference)
@lib/database/fivethreeone_blocks.dart (table schema reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getCompletedBlocks() query and blockHistoryPageHandler</name>
  <files>
    server/lib/services/dashboard_service.dart
    server/lib/api/dashboard_pages.dart
  </files>
  <action>
**1. DashboardService.getCompletedBlocks()** in `dashboard_service.dart`:

Add a `getCompletedBlocks()` method that:
- Returns `List<Map<String, dynamic>>` (empty list if `_db` is null)
- Checks table existence first: `SELECT name FROM sqlite_master WHERE type='table' AND name='five_three_one_blocks'` -- if missing, return empty list (old backups may not have this table)
- Queries completed blocks:
  ```sql
  SELECT id, created, completed,
    squat_tm, bench_tm, deadlift_tm, press_tm,
    COALESCE(start_squat_tm, squat_tm) as start_squat_tm,
    COALESCE(start_bench_tm, bench_tm) as start_bench_tm,
    COALESCE(start_deadlift_tm, deadlift_tm) as start_deadlift_tm,
    COALESCE(start_press_tm, press_tm) as start_press_tm,
    unit, current_cycle
  FROM five_three_one_blocks
  WHERE is_active = 0 AND completed IS NOT NULL
  ORDER BY completed DESC
  ```
- Maps rows to `Map<String, dynamic>` with camelCase keys: `id`, `created`, `completed`, `squatTm`, `benchTm`, `deadliftTm`, `pressTm`, `startSquatTm`, `startBenchTm`, `startDeadliftTm`, `startPressTm`, `unit`, `currentCycle`
- IMPORTANT: `created` and `completed` are stored as integer (Drift DateTimeColumn = seconds since epoch on SQLite). Cast numeric values with `(row['x'] as num).toDouble()` for TMs.

**2. blockHistoryPageHandler()** in `dashboard_pages.dart`:

Add function:
```dart
Response blockHistoryPageHandler(
  Request request,
  DashboardService dashboardService,
  String apiKey,
)
```

Follow the exact same pattern as `overviewPageHandler`:
- Open DB if not open, show "No backup data available" shell if still not open
- Call `dashboardService.getCompletedBlocks()`
- If empty, show "No 5/3/1 data" message in the shell

**Build the page content:**

**A. Block cards (each completed block):**
For each block, render a card with:
- Header (clickable, triggers `toggleBlock(index)`): date range ("Jan 5, 2026 - Feb 15, 2026") and 4 end TM values in a row (Squat, Bench, Deadlift, OHP) with label above each
- Arrow indicator for expand/collapse state
- Hidden detail section (`id="detail-{index}"`, `display:none` initially):
  - 2x2 grid of lift cards, each showing:
    - Lift name (bold)
    - Start TM -> End TM (e.g., "180 -> 189 kg")
    - Delta badge: green background + text for positive delta, red for negative, muted for zero. Use `rgba(34,197,94,0.15)` / `#22C55E` for green, `rgba(239,68,68,0.15)` / `#EF4444` for red
  - Cycle structure labels row below the grid: "Leader 1 -> Leader 2 -> 7th Week -> Anchor -> 7th Week" as styled inline badges (use the 5 names from `cycleNames` in schemes.dart: `['Leader 1', 'Leader 2', '7th Week Protocol', 'Anchor', '7th Week Protocol']`)

Format dates from epoch seconds: `DateTime.fromMillisecondsSinceEpoch(epoch * 1000)` then format as "MMM D, YYYY".

**B. Toggle JavaScript:**
```javascript
function toggleBlock(id) {
  const detail = document.getElementById('detail-' + id);
  const arrow = document.getElementById('arrow-' + id);
  const isHidden = detail.style.display === 'none';
  detail.style.display = isHidden ? 'block' : 'none';
  arrow.style.transform = isHidden ? 'rotate(180deg)' : '';
}
```

**C. TM Progression Chart (Chart.js grouped bar):**
- Only show chart section if blocks exist
- If more than 10 blocks, limit chart to last 10 (most recent) and add note "Showing last 10 blocks"
- Reverse order for chart so oldest is on left, newest on right
- Labels: "Block 1", "Block 2", ... (numbered from oldest)
- 4 datasets (one per lift): Squat (red `rgba(239,68,68,0.7)`), Bench (blue `rgba(59,130,246,0.7)`), Deadlift (green `rgba(34,197,94,0.7)`), OHP (orange `rgba(249,115,22,0.7)`)
- Each dataset uses end TM values (`squatTm`, `benchTm`, etc.)
- `borderRadius: 4`, `beginAtZero: false` on y-axis
- Use `textColor` and `gridColor` from CSS custom properties (same pattern as overview page charts)
- Embed blocks data as JSON in a `<script type="application/json" id="blocks-data">` tag

**D. Nav item in dashboardShell():**
Add a new nav item in the `<nav>` section of `dashboardShell()`, between "History" and "Backups":
```dart
${navItem('5/3/1 Blocks', '/dashboard/blocks', '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M3 1h10v2H3zm0 4h10v2H3zm0 4h10v2H3zm0 4h10v2H3z"/></svg>')}
```
(Simple stacked-bars icon representing block progression.)

**E. Include Chart.js CDN** in `extraHead` only when blocks exist. Put toggle script and chart script in `extraScripts`.
  </action>
  <verify>
    Grep for `getCompletedBlocks` in dashboard_service.dart and `blockHistoryPageHandler` in dashboard_pages.dart. Grep for `5/3/1 Blocks` in dashboardShell nav section. Grep for `/dashboard/blocks` in dashboard_pages.dart.
  </verify>
  <done>
    - getCompletedBlocks() method exists with table existence check and COALESCE for nullable start TMs
    - blockHistoryPageHandler returns full HTML page with block cards, inline expand/collapse, delta badges, cycle labels, and TM progression chart
    - "5/3/1 Blocks" nav item added to dashboardShell() sidebar between History and Backups
  </done>
</task>

<task type="auto">
  <name>Task 2: Register /dashboard/blocks route in server.dart</name>
  <files>
    server/bin/server.dart
  </files>
  <action>
Add route in `server.dart` after the `/dashboard/workout/<id>` route:

```dart
router.get('/dashboard/blocks',
    (req) => blockHistoryPageHandler(req, dashboardService, config.apiKey));
```

This follows the exact same pattern as the existing dashboard routes (no BackupService needed for this handler, same as exercisesPageHandler pattern).
  </action>
  <verify>
    Grep for `dashboard/blocks` in server.dart.
  </verify>
  <done>
    - /dashboard/blocks route registered and wired to blockHistoryPageHandler
  </done>
</task>

</tasks>

<verification>
1. `rg 'getCompletedBlocks' server/lib/services/dashboard_service.dart` finds the method
2. `rg 'blockHistoryPageHandler' server/lib/api/dashboard_pages.dart` finds the handler
3. `rg 'blockHistoryPageHandler' server/bin/server.dart` finds the route
4. `rg '5/3/1 Blocks' server/lib/api/dashboard_pages.dart` finds the nav item
5. `rg 'sqlite_master.*five_three_one_blocks' server/lib/services/dashboard_service.dart` confirms table existence check
6. `rg 'COALESCE.*start_squat_tm' server/lib/services/dashboard_service.dart` confirms COALESCE fallback
</verification>

<success_criteria>
- /dashboard/blocks page renders completed 5/3/1 blocks as cards with date range and end TM values
- Cards expand inline to show per-lift TM start->end with colored delta badges and cycle structure labels
- Grouped bar chart shows TM progression across blocks (limited to last 10 if many)
- "5/3/1 Blocks" appears in sidebar navigation on all dashboard pages
- Page gracefully handles missing table (old backups) and empty data
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-differentiators/14-01-SUMMARY.md`
</output>
