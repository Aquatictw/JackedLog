---
phase: 11-app-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/database/settings.dart
  - lib/database/database.dart
  - lib/server/server_settings_page.dart
  - lib/settings/settings_page.dart
autonomous: true

must_haves:
  truths:
    - "User can navigate to a Backup Server settings page from the main settings list"
    - "User can enter a server URL and it persists after leaving and returning to the page"
    - "User can enter an API key that is masked by default with a reveal toggle"
    - "Server URL and API key values survive app restart (stored in database)"
  artifacts:
    - path: "lib/database/settings.dart"
      provides: "4 new nullable columns for server integration"
      contains: "serverUrl, serverApiKey, lastPushTime, lastPushStatus"
    - path: "lib/database/database.dart"
      provides: "Migration v65 to v66 adding server columns"
      contains: "from < 66 && to >= 66"
    - path: "lib/server/server_settings_page.dart"
      provides: "Server settings page with URL field, API key field, and connection test"
    - path: "lib/settings/settings_page.dart"
      provides: "Backup Server navigation entry in settings list"
      contains: "ServerSettingsPage"
  key_links:
    - from: "lib/settings/settings_page.dart"
      to: "lib/server/server_settings_page.dart"
      via: "Navigator.push to ServerSettingsPage"
      pattern: "ServerSettingsPage"
    - from: "lib/server/server_settings_page.dart"
      to: "lib/database/database.dart"
      via: "SettingsCompanion write for serverUrl and serverApiKey"
      pattern: "SettingsCompanion.*serverUrl|serverApiKey"
---

<objective>
Add server integration columns to the database and create the server settings page where users configure their server URL and API key.

Purpose: Establishes the data model and configuration UI needed for all server communication. Without persisted URL and API key, the push feature (Plan 02) cannot function.

Output: Database migration v65->v66 with 4 new Settings columns, a new ServerSettingsPage accessible from the settings list, with URL input, masked API key input with reveal toggle, and connection test button.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/database/settings.dart
@lib/database/database.dart
@lib/settings/settings_page.dart
@lib/settings/settings_state.dart
@lib/settings/spotify_settings.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server columns to Settings table and migration</name>
  <files>lib/database/settings.dart, lib/database/database.dart</files>
  <action>
  Add 4 new nullable columns to the Settings table in `lib/database/settings.dart`:

  ```dart
  // Server backup push settings
  TextColumn get serverUrl => text().nullable()();
  TextColumn get serverApiKey => text().nullable()();
  DateTimeColumn get lastPushTime => dateTime().nullable()();
  TextColumn get lastPushStatus => text().nullable()();
  ```

  Add after the existing Spotify columns at the end of the class (before the closing brace).

  In `lib/database/database.dart`:

  1. Update `schemaVersion` from 65 to 66.

  2. Add migration block after the `from64To65` block (before the closing of `onUpgrade`):

  ```dart
  // from65To66: Add server backup push columns
  if (from < 66 && to >= 66) {
    await m.database.customStatement(
      'ALTER TABLE settings ADD COLUMN server_url TEXT',
    ).catchError((e) {});
    await m.database.customStatement(
      'ALTER TABLE settings ADD COLUMN server_api_key TEXT',
    ).catchError((e) {});
    await m.database.customStatement(
      'ALTER TABLE settings ADD COLUMN last_push_time INTEGER',
    ).catchError((e) {});
    await m.database.customStatement(
      'ALTER TABLE settings ADD COLUMN last_push_status TEXT',
    ).catchError((e) {});
  }
  ```

  Note: All columns are nullable so existing exported data can still be re-imported without these fields. This does NOT break backward compatibility — previous exports remain importable.
  </action>
  <verify>Grep for `serverUrl`, `serverApiKey`, `lastPushTime`, `lastPushStatus` in settings.dart to confirm columns exist. Grep for `from < 66` in database.dart to confirm migration block exists. Verify `schemaVersion => 66`.</verify>
  <done>Settings table has 4 new nullable columns. Database version is 66 with proper migration from 65. All columns nullable so import/export backward compatibility is maintained.</done>
</task>

<task type="auto">
  <name>Task 2: Create server settings page and add navigation entry</name>
  <files>lib/server/server_settings_page.dart, lib/settings/settings_page.dart</files>
  <action>
  Create `lib/server/server_settings_page.dart` — a StatefulWidget page for configuring the server connection. Follow the pattern from `spotify_settings.dart` for structure.

  **Page layout:**
  - AppBar with title "Backup Server"
  - ListView body with padding

  **Server URL field:**
  - TextFormField with label "Server URL"
  - Hint text: "https://myserver.com"
  - Keyboard type: `TextInputType.url`
  - Pre-filled from `settings.value.serverUrl` if not null
  - On blur (onFieldSubmitted or focusNode listener), strip trailing slash and save via `db.settings.update().write(SettingsCompanion(serverUrl: Value(trimmedUrl)))`. Also call `settings.init()` to refresh state.
  - Basic format validation: if non-empty, must start with `http://` or `https://`. Show error text if invalid.

  **API Key field:**
  - TextFormField with label "API Key"
  - `obscureText: true` by default
  - Suffix icon: eye toggle (Icons.visibility / Icons.visibility_off) to reveal/hide
  - Pre-filled from `settings.value.serverApiKey` if not null
  - On blur, save via `db.settings.update().write(SettingsCompanion(serverApiKey: Value(value)))`. Also call `settings.init()`.

  **Connection test button:**
  - FilledButton.tonal with icon `Icons.wifi_find` and text "Test Connection"
  - Disabled when URL is empty or API key is empty
  - On tap:
    1. Set local `_isTesting = true` state, show CircularProgressIndicator in button
    2. Import `package:http/http.dart` as http
    3. First: `GET {serverUrl}/api/health` — if fails, show error "Server unreachable: {error message}" in a status text below button (red text)
    4. Second: `GET {serverUrl}/api/backups` with header `Authorization: Bearer {apiKey}` — if 401/403, show "Invalid API key"; if success (200), show "Connected successfully" (green text with checkmark icon)
    5. Catch all exceptions (SocketException, TimeoutException, etc.) and show user-friendly error
    6. Use timeout of 10 seconds: `http.get(url).timeout(Duration(seconds: 10))`
    7. Set `_isTesting = false` when done
  - Status result displayed as a Container below the button with icon + text (similar to backup status indicator pattern)

  **Important details:**
  - Import the `http` package (already in pubspec.yaml)
  - Import `dart:async` for TimeoutException
  - Import `dart:io` for SocketException
  - Use `context.watch<SettingsState>()` for reactive updates
  - Use `context.read<SettingsState>()` for one-off reads in handlers
  - Access db via `import '../main.dart'` (global `db` variable) and `import '../database/database.dart'` for SettingsCompanion

  **In `lib/settings/settings_page.dart`:**
  - Add import: `import '../server/server_settings_page.dart';`
  - Add a new ListTile in the settings list (in the `else` branch where non-search entries are listed). Place it between the "Spotify" entry and the "5/3/1 Block" entry (or at the end before Spotify — use discretion for logical grouping, placing it after "Data management" makes most sense since it's data/backup related):

  ```dart
  ListTile(
    leading: const Icon(Icons.cloud_upload),
    title: const Text('Backup Server'),
    onTap: () => Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => const ServerSettingsPage(),
      ),
    ),
  ),
  ```

  Place after "Data management" ListTile since Backup Server is data-related.
  </action>
  <verify>Verify file exists at `lib/server/server_settings_page.dart`. Grep for `ServerSettingsPage` in settings_page.dart to confirm navigation entry. Grep for `cloud_upload` in settings_page.dart. Grep for `Test Connection` in server_settings_page.dart.</verify>
  <done>Server settings page exists with URL field, masked API key field with reveal toggle, and connection test button. Settings page has "Backup Server" entry that navigates to the new page. URL field strips trailing slashes on save. API key field is masked with visibility toggle. Connection test validates reachability and API key correctness.</done>
</task>

</tasks>

<verification>
1. `lib/database/settings.dart` contains `serverUrl`, `serverApiKey`, `lastPushTime`, `lastPushStatus` columns
2. `lib/database/database.dart` has `schemaVersion => 66` and migration block `from < 66 && to >= 66`
3. `lib/server/server_settings_page.dart` exists with URL field, API key field, connection test
4. `lib/settings/settings_page.dart` has "Backup Server" ListTile navigating to ServerSettingsPage
5. Migration uses only nullable columns (backward compatible with existing exports)
</verification>

<success_criteria>
- Settings table schema includes 4 new server-related nullable columns
- Database migration from 65 to 66 applies all 4 ALTER TABLE statements with catchError
- Server settings page is accessible from main settings list
- URL field validates format and strips trailing slashes
- API key field has masked/reveal toggle
- Connection test button hits health endpoint then authenticated endpoint, shows clear success/error feedback
</success_criteria>

<output>
After completion, create `.planning/phases/11-app-integration/11-01-SUMMARY.md`
</output>
