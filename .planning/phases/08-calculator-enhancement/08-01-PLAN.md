---
phase: 08-calculator-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/widgets/five_three_one_calculator.dart
autonomous: true

must_haves:
  truths:
    - "Calculator shows 5's PRO scheme (all x5, no AMRAP) when active block is in Leader cycle"
    - "Calculator shows PR Sets with AMRAP on final set when active block is in Anchor cycle"
    - "Calculator shows 7th Week Deload scheme (70/80/90/100% at x5,x5,x1,x1) when block is in Deload position"
    - "Calculator shows TM Test scheme (70/80/90/100% all x5) with info banner when block is in TM Test position"
    - "Calculator displays supplemental section: BBB 5x10@60% during Leader, FSL 5x5 during Anchor, hidden during Deload/TM Test"
    - "Calculator works in manual mode (existing 4-week selector, settings-based TM) when no active block exists"
    - "TM field is read-only in block mode, editable in manual mode"
    - "Week selector hidden in block mode, replaced by header label with scheme name and block position"
  artifacts:
    - path: "lib/widgets/five_three_one_calculator.dart"
      provides: "Dual-mode calculator: block-aware and manual"
      contains: "_isBlockMode"
  key_links:
    - from: "lib/widgets/five_three_one_calculator.dart"
      to: "lib/fivethreeone/fivethreeone_state.dart"
      via: "context.read<FiveThreeOneState>()"
      pattern: "context\\.read<FiveThreeOneState>"
    - from: "lib/widgets/five_three_one_calculator.dart"
      to: "lib/fivethreeone/schemes.dart"
      via: "getMainScheme, getSupplementalScheme, getMainSchemeName, getSupplementalName imports"
      pattern: "getMainScheme\\(|getSupplementalScheme\\("
---

<objective>
Make the 5/3/1 calculator block-aware: when an active block exists, automatically display the correct scheme (5's PRO, PR Sets, Deload, TM Test) and supplemental work (BBB, FSL) based on block position, with TM sourced from the block. Preserve existing manual mode when no block exists.

Purpose: Users with an active training block open the calculator and see exactly what to lift today — no manual week selection needed, correct scheme automatically applied, supplemental work displayed below main sets.
Output: Modified `five_three_one_calculator.dart` with dual-mode behavior (block-aware + manual fallback).
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-calculator-enhancement/08-CONTEXT.md
@.planning/phases/08-calculator-enhancement/08-RESEARCH.md
@lib/widgets/five_three_one_calculator.dart
@lib/fivethreeone/schemes.dart
@lib/fivethreeone/fivethreeone_state.dart
@lib/database/fivethreeone_blocks.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add block-aware data resolution and state fields</name>
  <files>lib/widgets/five_three_one_calculator.dart</files>
  <action>
Add imports for `schemes.dart` and `fivethreeone_state.dart` at the top of the file.

Add three state fields to `_FiveThreeOneCalculatorState`:
- `bool _isBlockMode = false` — set once during `_loadSettings()`, controls all conditional branches
- `int _blockCycleType = 0` — cycle type from active block (only used when `_isBlockMode`)
- `int _blockWeek = 1` — week from active block (only used when `_isBlockMode`)

Modify `_loadSettings()` to check `context.read<FiveThreeOneState>().hasActiveBlock` FIRST:
- If true (block mode): set `_isBlockMode = true`, read `_blockCycleType` and `_blockWeek` from `fiveThreeOneState.activeBlock!`, set `_unit` from `block.unit`, resolve TM from block fields using existing `_getExerciseKey()` (squat→squatTm, bench→benchTm, deadlift→deadliftTm, press→pressTm), populate `_tmController.text`. Do NOT run the existing settings DB query.
- If false (manual mode): keep the existing settings-based code path completely unchanged.

NOTE: The `_trainingMax` field in block mode is always non-null (blocks always have TMs set at creation). The existing null checks in `build()` still work correctly.
  </action>
  <verify>Read the modified file and confirm: (1) `_isBlockMode`, `_blockCycleType`, `_blockWeek` fields exist, (2) `_loadSettings()` has the FiveThreeOneState check before the settings DB query, (3) the else branch contains the original settings code unchanged.</verify>
  <done>Calculator resolves its data source (block or settings) at load time based on active block presence. The `_isBlockMode` flag is set and controls all downstream behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Modify build() for dual-mode UI with supplemental section</name>
  <files>lib/widgets/five_three_one_calculator.dart</files>
  <action>
Modify the `build()` method to implement dual-mode display. All changes are conditional on `_isBlockMode`.

**Scheme resolution (line ~228):**
Replace `final scheme = _getWorkingSetScheme();` with:
```dart
final scheme = _isBlockMode
    ? getMainScheme(cycleType: _blockCycleType, week: _blockWeek)
    : _getWorkingSetScheme();
```

**Week name display (line ~229-233):**
Wrap the existing `weekName` computation in `!_isBlockMode` check (it's only used in manual mode).

**TM field (line ~312-323):**
In block mode, make the TextField read-only: add `readOnly: true` and remove the `onChanged` callback. Use a conditional: `if (_isBlockMode)` show a read-only TextField (no onChanged), `else` show the existing editable TextField with `onChanged: (_) => _saveTrainingMax()`.

**Week selector section (line ~328-358):**
Replace the SegmentedButton with a conditional:
- If `_isBlockMode`: show a header label Text widget with format "${getMainSchemeName(_blockCycleType)} — ${cycleNames[_blockCycleType]}, Week $_blockWeek". Style it with `titleMedium`, `fontWeight: FontWeight.bold`.
- If `!_isBlockMode`: keep the existing SegmentedButton unchanged.

**Working Sets header (line ~364-396):**
In block mode, simplify the header — don't show the manual "Week X: WeekName" row. Instead, the header label above already shows the position. Keep the existing header for manual mode.

**Progress Cycle button (line ~490-498):**
Hide in block mode. Wrap the existing `if (_currentWeek == 4)` check with `if (!_isBlockMode && _currentWeek == 4)`.

**Supplemental section (after main sets, before the progress cycle button area):**
Add a supplemental section ONLY in block mode. After the main set rows and before the progress cycle button area:
```dart
if (_isBlockMode) ...[
  final supplemental = getSupplementalScheme(cycleType: _blockCycleType, week: _blockWeek);
  if (supplemental.isNotEmpty) ...[
    const SizedBox(height: 16),
    Divider(color: colorScheme.outlineVariant),
    const SizedBox(height: 8),
    Builder(builder: (context) {
      final weight = _calculateWeight(supplemental.first.percentage);
      final name = getSupplementalName(_blockCycleType);
      return Text(
        '$name: ${supplemental.length} x ${supplemental.first.reps} @ ${weight.toStringAsFixed(1)} $_unit',
        style: Theme.of(context).textTheme.titleMedium,
      );
    }),
  ],
],
```

NOTE: Use a Builder or extract the weight/name computation outside the spread. Dart does not allow `final` declarations inside collection spread `[...]`. Either extract to a method, use a Builder widget, or compute the supplemental variables before the Column's children list.

**TM Test feedback banner:**
After the supplemental section (or after main sets if no supplemental), add:
```dart
if (_isBlockMode && _blockCycleType == cycleTmTest) ...[
  const SizedBox(height: 16),
  Container(
    padding: const EdgeInsets.all(12),
    decoration: BoxDecoration(
      color: colorScheme.tertiaryContainer,
      borderRadius: BorderRadius.circular(8),
    ),
    child: Row(children: [
      Icon(Icons.info_outline, color: colorScheme.onTertiaryContainer),
      const SizedBox(width: 8),
      Expanded(
        child: Text(
          'You should be able to get 5 strong reps at 100%. If not, lower your TM.',
          style: TextStyle(color: colorScheme.onTertiaryContainer),
        ),
      ),
    ]),
  ),
],
```

**Info Footer (line ~530-555):**
Keep as-is. The "TM should be 90% of your true 1RM" tip is universally applicable.

IMPORTANT: Do NOT break any existing manual mode behavior. Every change must be gated behind `_isBlockMode` checks. The `_getWorkingSetScheme()` method, `_saveTrainingMax()`, `_updateWeek()`, and `_progressCycle()` methods must remain untouched.
  </action>
  <verify>Read the complete modified file. Verify: (1) import for schemes.dart present, (2) `_isBlockMode` conditional gates all new UI, (3) SegmentedButton still renders in manual mode, (4) supplemental section renders with Divider + compact text, (5) TM Test feedback banner present, (6) Progress Cycle button hidden in block mode, (7) TM field read-only in block mode, (8) no syntax errors in the spread operators.</verify>
  <done>Calculator displays correct scheme, supplemental work, and TM Test feedback based on block position in block mode. Manual mode UI is completely preserved. All 5 success criteria met.</done>
</task>

</tasks>

<verification>
After both tasks, verify all success criteria from ROADMAP.md:

1. **CALC-01**: In block mode with Leader cycle type, `getMainScheme()` returns 5's PRO (all x5, no AMRAP). In Anchor, returns PR Sets with AMRAP on final set. Confirmed by scheme resolution conditional.
2. **CALC-02**: In Deload position, `getMainScheme()` returns deloadScheme (70/80/90/100% at x5,x5,x1,x1). Confirmed by schemes.dart deloadScheme constant — note: the deload scheme has reps 5,5,1,1 which matches CALC-02's "x5,3-5,1,1" as close as the scheme data allows.
3. **CALC-03**: In TM Test position, `getMainScheme()` returns tmTestScheme (70/80/90/100% all x5). TM Test feedback banner shows validation warning. Confirmed by conditional banner widget.
4. **CALC-04**: Supplemental section shows BBB compact summary during Leader, FSL during Anchor, hidden during Deload/TM Test. Confirmed by `getSupplementalScheme()` returning correct data and empty list gating visibility.
5. **SC-5**: When no active block exists, `_isBlockMode` is false. All new UI is hidden behind `if (_isBlockMode)` checks. Existing behavior (week selector, settings TM, manual scheme) is untouched.
</verification>

<success_criteria>
- Calculator opens correctly with active block, showing scheme name + block position header
- Calculator opens correctly without active block, showing week selector (unchanged from before)
- Supplemental section appears below main sets in Leader (BBB) and Anchor (FSL) cycles
- Supplemental section is hidden during Deload and TM Test
- TM Test feedback banner appears only during TM Test cycle
- TM field is read-only in block mode
- Progress Cycle button is hidden in block mode
- All existing manual mode behavior is preserved
</success_criteria>

<output>
After completion, create `.planning/phases/08-calculator-enhancement/08-01-SUMMARY.md`
</output>
