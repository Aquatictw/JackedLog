---
phase: 05-backup-status-stability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/workouts/active_workout_bar.dart
  - lib/settings/settings_state.dart
  - lib/database/settings.dart
  - lib/database/database.dart
  - lib/backup/auto_backup_service.dart
  - lib/backup/auto_backup_settings.dart
autonomous: true

must_haves:
  truths:
    - "Timer callback checks mounted BEFORE accessing context"
    - "Settings stream uses watchSingleOrNull() and handles null gracefully"
    - "Backup status (success/failed) is persisted to database"
    - "Settings page shows backup status indicator with appropriate visual"
  artifacts:
    - path: "lib/workouts/active_workout_bar.dart"
      provides: "Safe timer callback with mounted check before context.read"
      contains: "if (!mounted) return"
    - path: "lib/settings/settings_state.dart"
      provides: "Safe settings stream with watchSingleOrNull"
      contains: "watchSingleOrNull"
    - path: "lib/database/settings.dart"
      provides: "lastBackupStatus column definition"
      contains: "lastBackupStatus"
    - path: "lib/backup/auto_backup_settings.dart"
      provides: "Backup status indicator widget"
      contains: "_buildBackupStatusIndicator"
  key_links:
    - from: "lib/backup/auto_backup_service.dart"
      to: "lib/database/settings.dart"
      via: "updates lastBackupStatus on success/failure"
      pattern: "lastBackupStatus.*Value"
---

<objective>
Implement backup status tracking and fix async stability issues for Phase 5.

Purpose: Users can see backup health at a glance; async operations are safe from context issues
Output: Safe timer callbacks, safe settings stream, backup status tracking with UI indicator
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-backup-status-stability/05-RESEARCH.md

# Source files
@lib/workouts/active_workout_bar.dart
@lib/settings/settings_state.dart
@lib/database/settings.dart
@lib/database/database.dart
@lib/backup/auto_backup_service.dart
@lib/backup/auto_backup_settings.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix async stability issues (STB-01, STB-02)</name>
  <files>
    lib/workouts/active_workout_bar.dart
    lib/settings/settings_state.dart
  </files>
  <action>
**Fix active_workout_bar.dart timer callback (STB-01):**

In `_startTimer()` method, change the timer callback to check `mounted` BEFORE accessing context:

```dart
void _startTimer() {
  _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
    if (!mounted) return;  // Exit early if widget disposed

    final workoutState = context.read<WorkoutState>();
    if (workoutState.activeWorkout != null) {
      setState(() {
        _elapsed = DateTime.now()
            .difference(workoutState.activeWorkout!.startTime);
      });
    }
  });
}
```

The key change: Move `context.read<WorkoutState>()` OUTSIDE of `setState()` and check `mounted` before any context access.

**Fix settings_state.dart stream query (STB-02):**

In `init()` method, change `watchSingle()` to `watchSingleOrNull()` and handle null:

```dart
Future<void> init() async {
  subscription =
      (db.settings.select()..limit(1)).watchSingleOrNull().listen((event) {
    if (event != null) {
      value = event;
      notifyListeners();
    }
    // If event is null, keep existing value (graceful degradation)
  });
}
```
  </action>
  <verify>
Code compiles without errors. Timer callback has `if (!mounted) return` before any context access. Settings stream uses `watchSingleOrNull()`.
  </verify>
  <done>
STB-01: Timer checks mounted before context access, preventing "deactivated widget" errors during hot reload.
STB-02: Settings stream handles empty table gracefully without throwing StateError.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add backup status tracking and UI (BAK-01, BAK-02)</name>
  <files>
    lib/database/settings.dart
    lib/database/database.dart
    lib/backup/auto_backup_service.dart
    lib/backup/auto_backup_settings.dart
  </files>
  <action>
**1. Add lastBackupStatus column to Settings table (lib/database/settings.dart):**

Add after `lastAutoBackupTime`:
```dart
TextColumn get lastBackupStatus => text().nullable()();
// Values: null (never attempted), 'success', 'failed'
```

**2. Bump schema version and add migration (lib/database/database.dart):**

Change `schemaVersion` from 62 to 63.

Add migration case in the migration strategy (find the migration switch/if block):
```dart
if (from < 63) {
  await m.addColumn(settings, settings.lastBackupStatus);
}
```

**3. Update auto_backup_service.dart to track status:**

In `performAutoBackup()` - after successful backup (after updating lastAutoBackupTime):
```dart
await db.settings.update().write(
  SettingsCompanion(
    lastAutoBackupTime: Value(DateTime.now()),
    lastBackupStatus: const Value('success'),
  ),
);
```

In `performAutoBackup()` catch block - update status to failed:
```dart
} catch (e) {
  print('ERROR [AutoBackup] Backup failed');
  // ... existing logging ...

  // Track failure status
  await db.settings.update().write(
    const SettingsCompanion(
      lastBackupStatus: Value('failed'),
    ),
  );

  return false;
}
```

In `performManualBackup()` - add status tracking (combine with existing lastAutoBackupTime update):
```dart
await db.settings.update().write(
  SettingsCompanion(
    lastAutoBackupTime: Value(DateTime.now()),
    lastBackupStatus: const Value('success'),
  ),
);
```

**4. Add backup status indicator to auto_backup_settings.dart:**

Add helper method for building status indicator:
```dart
Widget _buildBackupStatusIndicator(
  BuildContext context,
  String? status,
  DateTime? lastBackupTime,
) {
  final colorScheme = Theme.of(context).colorScheme;

  IconData icon;
  String label;
  Color color;

  if (lastBackupTime == null) {
    icon = Icons.backup_outlined;
    label = 'Never';
    color = colorScheme.outline;
  } else if (status == 'failed') {
    icon = Icons.error_outline_rounded;
    label = 'Failed';
    color = colorScheme.error;
  } else {
    icon = Icons.check_circle_outline_rounded;
    label = 'Success';
    color = colorScheme.primary;
  }

  return Row(
    mainAxisSize: MainAxisSize.min,
    children: [
      Icon(icon, size: 16, color: color),
      const SizedBox(width: 6),
      Text(
        label,
        style: TextStyle(
          color: color,
          fontWeight: FontWeight.w600,
          fontSize: 13,
        ),
      ),
    ],
  );
}
```

**5. Update "Last Backup" section in build() to always show (not just when auto-backups enabled) and include status indicator:**

Replace the existing `if (settings.value.lastAutoBackupTime != null)` block with a version that:
- Always shows when auto-backups are enabled (even if lastAutoBackupTime is null - show "Never")
- Includes the status indicator alongside the timestamp

Update the Last Backup container to include status:
```dart
Container(
  padding: const EdgeInsets.all(16),
  decoration: BoxDecoration(
    color: colorScheme.surfaceContainerHighest.withValues(alpha: 0.5),
    borderRadius: BorderRadius.circular(12),
    border: Border.all(
      color: colorScheme.outlineVariant,
    ),
  ),
  child: Row(
    children: [
      Icon(
        Icons.schedule_rounded,
        color: colorScheme.secondary,
        size: 20,
      ),
      const SizedBox(width: 12),
      Expanded(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Last Backup',
              style: Theme.of(context)
                  .textTheme
                  .bodySmall
                  ?.copyWith(
                    color: colorScheme.onSurfaceVariant,
                    fontWeight: FontWeight.w500,
                  ),
            ),
            const SizedBox(height: 2),
            Text(
              settings.value.lastAutoBackupTime != null
                  ? timeago.format(settings.value.lastAutoBackupTime!)
                  : 'Never',
              style: Theme.of(context)
                  .textTheme
                  .bodyMedium
                  ?.copyWith(
                    color: colorScheme.onSurface,
                    fontWeight: FontWeight.w600,
                  ),
            ),
          ],
        ),
      ),
      _buildBackupStatusIndicator(
        context,
        settings.value.lastBackupStatus,
        settings.value.lastAutoBackupTime,
      ),
    ],
  ),
),
```

Remove the `if (settings.value.lastAutoBackupTime != null)` condition so this always shows when auto-backups are enabled.
  </action>
  <verify>
Code compiles without errors. Database migration adds lastBackupStatus column. Backup service updates status on success/failure. Settings UI shows status indicator.
  </verify>
  <done>
BAK-01: Settings page shows timestamp of last successful backup (or "Never" if none).
BAK-02: Settings page shows backup status indicator (success/failed/never) with appropriate visual styling.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Code compiles: All Dart files have no syntax errors
2. STB-01: `active_workout_bar.dart` timer callback checks `mounted` before `context.read()`
3. STB-02: `settings_state.dart` uses `watchSingleOrNull()`
4. BAK-01: Settings shows "Last Backup: X ago" or "Last Backup: Never"
5. BAK-02: Status indicator shows success (green check), failed (red error), or never (gray)
6. Database: Schema version is 63, migration adds `lastBackupStatus` column
</verification>

<success_criteria>
- STB-01: Timer safely handles widget disposal without context errors
- STB-02: Settings stream handles empty table without StateError
- BAK-01: Last backup timestamp always visible when auto-backups enabled
- BAK-02: Backup status indicator shows clear visual state
- All 4 requirements (BAK-01, BAK-02, STB-01, STB-02) addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-backup-status-stability/05-01-SUMMARY.md`
</output>
