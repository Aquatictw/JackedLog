---
phase: 13-dashboard-frontend
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - server/lib/api/dashboard_pages.dart
autonomous: true

must_haves:
  truths:
    - "Exercise list page shows all exercises with search bar and category filter dropdown"
    - "Exercise detail page shows personal records, rep records table, and progress line charts"
    - "Progress charts have period selector (Week/Month/3M/6M/Year/All) and metric selector (Best Weight/1RM/Volume)"
    - "Charts match app style: curved line, gradient fill below, no dots, dashed trend line"
  artifacts:
    - path: "server/lib/api/dashboard_pages.dart"
      provides: "Exercise list and detail page handlers"
      contains: "exercisesPageHandler"
  key_links:
    - from: "server/lib/api/dashboard_pages.dart"
      to: "server/lib/services/dashboard_service.dart"
      via: "searchExercises, getExerciseRecords, getRepRecords, getExerciseProgress calls"
      pattern: "dashboard\\.searchExercises|dashboard\\.getExerciseRecords|dashboard\\.getRepRecords|dashboard\\.getExerciseProgress"
    - from: "exercises list page"
      to: "exercise detail page"
      via: "href links with exercise name"
      pattern: "/dashboard/exercise/"
---

<objective>
Build the exercises list page and exercise detail page with search, filtering, records, and progress charts.

Purpose: Allow users to browse their exercise catalog, view personal records, and track strength progress over time with interactive charts.
Output: Working exercises list page at /dashboard/exercises and exercise detail page at /dashboard/exercise/:name with PRs, rep records, and Chart.js progress charts.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-dashboard-frontend/13-CONTEXT.md
@.planning/phases/13-dashboard-frontend/13-RESEARCH.md
@.planning/phases/13-dashboard-frontend/13-01-SUMMARY.md
@server/lib/api/dashboard_pages.dart
@server/lib/services/dashboard_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Exercise list page with search and category filter</name>
  <files>server/lib/api/dashboard_pages.dart</files>
  <action>
Replace the stub `exercisesPageHandler` with a full implementation.

**Handler:** `exercisesPageHandler(Request request, DashboardService dashboard, String apiKey)` -> Response

- Read query parameters: `search` (default ''), `category` (default null/empty)
- Open dashboard if needed
- Call `dashboard.getCategories()` for filter dropdown options
- Call `dashboard.searchExercises(search: search, category: category)` for exercise list
- Build page content:

**Search/filter bar** (top of page):
- Text input for search (name attribute "search", placeholder "Search exercises...", value pre-filled from query param)
- Dropdown select for category filter (name "category", with "All Categories" as default plus each category from getCategories())
- Both wrapped in a `<form method="GET" action="/dashboard/exercises">` with a hidden `<input name="key" value="$apiKey">`
- Submit on change (dropdown) or on enter (search). Add `onchange="this.form.submit()"` to the select element.
- Style: flexbox row, gap, inputs with dark surface background, border, rounded corners, text color matching theme

**Exercise list** (card grid below search):
- CSS Grid: 1 column on mobile, 2 on tablet, 3 on desktop
- Each exercise card: clickable link to `/dashboard/exercise/${Uri.encodeComponent(exercise.name)}?key=$apiKey`
- Card content:
  - Exercise name (bold, primary text)
  - Category badge (small pill with accent-dim background)
  - Stats row: "X workouts" and "Y sets" in muted text
  - Last used date (formatted, muted text)
- Card style: `background: var(--surface)`, border, border-radius 8px, padding, hover effect (border-color: var(--accent))

**Empty state:** If no exercises match, show centered message "No exercises found" with muted text.

**No data state:** If dashboard has no data, show "No backup data available" message.

Use StringBuffer for building the exercise card list.
  </action>
  <verify>Search for the handler and key elements: `rg "exercisesPageHandler|search.*exercises|category.*filter|exercise-card" server/lib/api/dashboard_pages.dart`</verify>
  <done>Exercises page at /dashboard/exercises shows searchable, filterable exercise list with cards linking to detail pages. Search and category filter work via form submission with query parameters.</done>
</task>

<task type="auto">
  <name>Task 2: Exercise detail page with records and progress charts</name>
  <files>server/lib/api/dashboard_pages.dart</files>
  <action>
Replace the stub `exerciseDetailHandler` with a full implementation.

**Handler:** `exerciseDetailHandler(Request request, String name, DashboardService dashboard, String apiKey)` -> Response

- Decode exercise name: `Uri.decodeComponent(name)`
- Read query parameters: `metric` (default 'bestWeight'), `period` (default 'all')
- Open dashboard if needed
- Call `dashboard.getExerciseRecords(exerciseName)` for PRs
- Call `dashboard.getRepRecords(exerciseName)` for rep records table
- Call `dashboard.getExerciseProgress(exerciseName, metric: metric, period: period)` for chart data
- Compute trend line server-side: simple linear regression (least squares) over the progress data points, output as 2-point array [first, last] for Chart.js dashed line

**Page content:**

1. **Breadcrumb/back link:** "Exercises > Exercise Name" with link back to exercises list

2. **Personal Records cards** (3 cards in a row):
   - Best Weight (with unit), Estimated 1RM, Best Volume
   - Each card: label, large formatted number, unit
   - Style similar to overview stats cards

3. **Period selector** (tab/button row):
   - Options: Week, Month, 3M, 6M, Year, All Time
   - Each is a link: `/dashboard/exercise/${Uri.encodeComponent(name)}?key=$apiKey&metric=$metric&period=week` (etc.)
   - Active period highlighted with accent background
   - Style: horizontal pill buttons, flexbox, gap

4. **Metric selector** (tab/button row below period):
   - Options: Best Weight, Est. 1RM, Volume
   - Each is a link with the current period preserved: `&metric=bestWeight`, `&metric=oneRepMax`, `&metric=volume`
   - Active metric highlighted

5. **Progress chart** (Chart.js line chart):
   - Load Chart.js from CDN (in extraHead/extraScripts)
   - Embed progress data as JSON in `<script type="application/json" id="progress-data">`
   - Embed trend data as JSON in `<script type="application/json" id="trend-data">`
   - Canvas element with fixed height container (300px)
   - Chart.js config:
     - type: 'line'
     - Curved line: `tension: 0.35`
     - Gradient fill: Use backgroundColor callback that creates gradient from `rgba(124,58,237,0.3)` top to `rgba(124,58,237,0.02)` bottom using chartArea dimensions. Fallback to solid rgba when chartArea not ready.
     - `fill: 'origin'`
     - `pointRadius: 0` (no dots)
     - `borderColor: '#7C3AED'`, `borderWidth: 3`
     - X-axis: date labels formatted as 'MMM DD' (use JS Date formatting), grid hidden
     - Y-axis: auto-scale, grid in `var(--border)` color
     - Trend line as second dataset: `borderDash: [5, 5]`, `borderColor: 'rgba(124,58,237,0.5)'`, `pointRadius: 0`, `fill: false`
   - If no progress data, show "No data for this period" message instead of chart

6. **Rep Records table:**
   - Table with columns: Reps, Best Weight, Unit
   - Rows for each rep count (1-15) that has data
   - Style: same table style as manage page (dark rows, border-bottom)
   - Empty state: "No rep records" if empty

**Trend line computation** (Dart, in the handler):
```
// Simple linear regression: y = mx + b
// x = index (0..n-1), y = metric value
// m = (n*sum(xy) - sum(x)*sum(y)) / (n*sum(x^2) - (sum(x))^2)
// b = (sum(y) - m*sum(x)) / n
```
Return first and last points as [{created, value}, {created, value}] for Chart.js.

**Important:** All links preserve the ?key= parameter. Use Uri.encodeComponent for exercise names in URLs.
  </action>
  <verify>Search for key implementation elements: `rg "exerciseDetailHandler|getExerciseProgress|trend|progress-data|rep-records" server/lib/api/dashboard_pages.dart`</verify>
  <done>Exercise detail page shows 3 PR cards, period/metric selectors, Chart.js progress line chart with gradient fill and dashed trend line, and rep records table. Period and metric selectors navigate via full page reload with query parameters.</done>
</task>

</tasks>

<verification>
1. exercisesPageHandler returns HTML with search input, category dropdown, and exercise card grid
2. exerciseDetailHandler returns HTML with PR cards, selectors, Chart.js line chart, and rep records table
3. Search form submits via GET with key, search, and category query parameters
4. Period/metric selectors are links that preserve all other query parameters
5. Chart.js line chart has curved line (tension 0.35), gradient fill, no dots, and dashed trend line
6. Exercise names are URL-encoded in all links
7. All pages use dashboardShell with correct activeNav ("Exercises")
</verification>

<success_criteria>
- `dart analyze server/` passes with no errors
- Exercises page renders exercise cards with search and filter functionality
- Exercise detail page renders PR cards, progress chart with Chart.js, and rep records table
- Period selector links correctly filter chart data via page reload
- Metric selector links switch between bestWeight, oneRepMax, volume
- All internal links include ?key= parameter
</success_criteria>

<output>
After completion, create `.planning/phases/13-dashboard-frontend/13-02-SUMMARY.md`
</output>
