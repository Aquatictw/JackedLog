---
phase: 13-dashboard-frontend
plan: 03
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - server/lib/api/dashboard_pages.dart
autonomous: true

must_haves:
  truths:
    - "History page lists workouts with pagination (20 per page) showing workout name, date, set count, and best set"
    - "Workout detail page shows all sets grouped by exercise with weight/reps"
    - "Pagination shows page numbers at bottom with current page highlighted"
    - "History cards link to workout detail pages"
  artifacts:
    - path: "server/lib/api/dashboard_pages.dart"
      provides: "History list and workout detail page handlers"
      contains: "historyPageHandler"
  key_links:
    - from: "server/lib/api/dashboard_pages.dart"
      to: "server/lib/services/dashboard_service.dart"
      via: "getWorkoutHistory and getWorkoutDetail calls"
      pattern: "dashboard\\.getWorkoutHistory|dashboard\\.getWorkoutDetail"
    - from: "history list"
      to: "workout detail"
      via: "href links with workout ID"
      pattern: "/dashboard/workout/"
---

<objective>
Build the workout history list page with pagination and the workout detail page showing sets grouped by exercise.

Purpose: Allow users to browse past workouts and see the details of any individual workout session.
Output: Working history page at /dashboard/history with paginated workout cards and workout detail page at /dashboard/workout/:id.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-dashboard-frontend/13-CONTEXT.md
@.planning/phases/13-dashboard-frontend/13-RESEARCH.md
@.planning/phases/13-dashboard-frontend/13-01-SUMMARY.md
@server/lib/api/dashboard_pages.dart
@server/lib/services/dashboard_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: History list page with pagination</name>
  <files>server/lib/api/dashboard_pages.dart</files>
  <action>
Replace the stub `historyPageHandler` with a full implementation.

**Handler:** `historyPageHandler(Request request, DashboardService dashboard, String apiKey)` -> Response

- Read query parameter: `page` (default 1, parse as int)
- Open dashboard if needed
- Call `dashboard.getWorkoutHistory(page: page, pageSize: 20)`
- Build page content:

**Workout card list** (vertical list):
- Each workout as a card (link to `/dashboard/workout/${workout['id']}?key=$apiKey`)
- Card layout (flexbox row, align center):
  - Left: Calendar-style date display (month abbreviated on top, day number large below, e.g. "FEB" / "15")
  - Center: Workout name (bold), time/duration info in muted text (format start_time as "HH:MM", calculate duration from end_time - start_time if available)
  - Right: Stat chips - "${setCount} sets" and volume formatted with K/M suffix
- Card style: `background: var(--surface)`, border, border-radius 8px, padding 1rem, margin-bottom 0.75rem, hover border-color change
- Format timestamps: Use Dart `DateTime.fromMillisecondsSinceEpoch(startTime * 1000)` to extract date parts

**Pagination** (bottom of page):
- Calculate total pages: `(totalCount / 20).ceil()`
- Show page number links: `1, 2, 3 ... N`
- If >7 pages, show: `1 2 3 ... N-1 N` with ellipsis (show first 3, ellipsis, last 2; shift window around current page)
- Current page: accent background, white text
- Other pages: surface background, text color, hover effect
- Each page link: `/dashboard/history?key=$apiKey&page=X`
- Style: horizontal flexbox, gap 4px, page buttons are 36x36px rounded squares, centered text

**Empty state:** If no workouts, show "No workouts recorded" centered message.

**No data state:** If dashboard has no data, show "No backup data available" message.

Use StringBuffer for building the workout card list.
  </action>
  <verify>Search for the handler and key elements: `rg "historyPageHandler|workout-card|pagination|page-link" server/lib/api/dashboard_pages.dart`</verify>
  <done>History page at /dashboard/history shows paginated workout cards with date display, workout name, duration, and stats. Pagination with page numbers at bottom navigates via query parameter.</done>
</task>

<task type="auto">
  <name>Task 2: Workout detail page</name>
  <files>server/lib/api/dashboard_pages.dart</files>
  <action>
Replace the stub `workoutDetailHandler` with a full implementation.

**Handler:** `workoutDetailHandler(Request request, String id, DashboardService dashboard, String apiKey)` -> Response

- Parse workout ID: `int.tryParse(id)` (return 404 if invalid)
- Open dashboard if needed
- Call `dashboard.getWorkoutDetail(workoutId)`
- If workout is null, return a "Workout not found" page wrapped in dashboardShell

**Page content:**

1. **Back link:** "History" link back to `/dashboard/history?key=$apiKey`

2. **Workout header:**
   - Workout name (large heading)
   - Date and time (formatted from start_time epoch)
   - Duration (end_time - start_time, formatted as "Xh Ym" or "Ym")
   - Notes (if present, displayed below in muted text with italic style)

3. **Workout stats row** (3 small stat cards):
   - Total exercises (count distinct exercise names from sets)
   - Total sets (count of sets)
   - Total volume (sum of weight * reps, formatted with K/M suffix)

4. **Sets grouped by exercise:**
   - Group the sets list by exercise name (iterate sets, collect into Map<String, List>)
   - For each exercise group:
     - Exercise name as section header (bold, with category badge if available)
     - Table or list of sets:
       - Column headers: Set #, Weight, Reps, (optional: set type if not 'normal')
       - Each set row: sequential number within exercise, weight + unit, reps
       - Highlight the best set (highest weight * reps) with accent color or bold
     - Style: compact table within a card, subtle alternating row backgrounds
   - Sections separated by spacing

5. **Empty state:** If workout has no sets, show "No sets recorded" message.

**Formatting helpers:**
- Date: Use Dart DateTime to format "Monday, February 15, 2026 at 10:30 AM" or similar readable format
- Duration: Convert seconds to "1h 23m" format
- Volume: Use K/M suffix for large numbers (e.g., "12.5K")
- Weight: Display with unit (e.g., "100 kg" or "225 lbs")

Use StringBuffer for building set tables.
  </action>
  <verify>Search for the handler and key elements: `rg "workoutDetailHandler|workout-header|exercise-group|set-table" server/lib/api/dashboard_pages.dart`</verify>
  <done>Workout detail page at /dashboard/workout/:id shows workout header (name, date, duration, notes), stats row, and all sets grouped by exercise with set numbers, weights, reps, and best-set highlighting.</done>
</task>

</tasks>

<verification>
1. historyPageHandler returns HTML with workout card list and pagination
2. workoutDetailHandler returns HTML with workout header, stats, and grouped sets
3. Pagination correctly shows page numbers and highlights current page
4. Workout cards link to correct workout detail page with ?key= parameter
5. Workout detail groups sets by exercise name with sequential set numbers
6. Best set per exercise group is highlighted
7. All pages use dashboardShell with correct activeNav ("History")
8. Empty states and error states handled (no data, workout not found)
</verification>

<success_criteria>
- `dart analyze server/` passes with no errors
- History page renders workout cards with proper date formatting and pagination
- Clicking a workout card navigates to the detail page
- Workout detail page renders sets grouped by exercise with weights and reps
- Pagination links navigate between pages correctly
- All internal links include ?key= parameter
- 404 handling for invalid workout IDs
</success_criteria>

<output>
After completion, create `.planning/phases/13-dashboard-frontend/13-03-SUMMARY.md`
</output>
