---
phase: 13-dashboard-frontend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/lib/services/dashboard_service.dart
  - server/lib/middleware/auth.dart
  - server/bin/server.dart
  - server/lib/api/dashboard_pages.dart
autonomous: true

must_haves:
  truths:
    - "DashboardService has getTrainingDays, getMuscleGroupVolumes, getMuscleGroupSetCounts, and getExerciseProgress methods"
    - "Dashboard routes use query parameter auth (?key=) like the manage page"
    - "Overview page displays 4 stats cards, SVG heatmap, and 2 Chart.js bar charts"
    - "Layout has responsive sidebar (desktop) / hamburger menu (mobile) and dark/light theme toggle"
  artifacts:
    - path: "server/lib/services/dashboard_service.dart"
      provides: "4 new query methods for heatmap, muscle charts, and exercise progress"
      contains: "getTrainingDays"
    - path: "server/lib/middleware/auth.dart"
      provides: "Query parameter auth for dashboard routes"
      contains: "dashboard"
    - path: "server/bin/server.dart"
      provides: "Dashboard route registrations"
      contains: "dashboardService"
    - path: "server/lib/api/dashboard_pages.dart"
      provides: "Shared layout shell and overview page handler"
      contains: "dashboardShell"
  key_links:
    - from: "server/bin/server.dart"
      to: "server/lib/api/dashboard_pages.dart"
      via: "import and route handler reference"
      pattern: "overviewPageHandler"
    - from: "server/lib/api/dashboard_pages.dart"
      to: "server/lib/services/dashboard_service.dart"
      via: "DashboardService method calls"
      pattern: "dashboard\\.get"
---

<objective>
Add the 4 missing DashboardService query methods, wire up dashboard routing with auth, and build the shared layout shell with the overview page.

Purpose: Establish the dashboard infrastructure (queries, routing, layout) and deliver the first visible page (overview with stats, heatmap, muscle charts).
Output: Working overview page at /dashboard?key=xxx with stats cards, training heatmap, muscle group volume/set-count bar charts, responsive sidebar, and dark/light theme toggle.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-dashboard-frontend/13-CONTEXT.md
@.planning/phases/13-dashboard-frontend/13-RESEARCH.md
@.planning/phases/12-dashboard-query-layer/12-01-SUMMARY.md
@.planning/phases/12-dashboard-query-layer/12-02-SUMMARY.md
@server/lib/services/dashboard_service.dart
@server/lib/middleware/auth.dart
@server/bin/server.dart
@server/lib/api/manage_page.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 4 missing query methods to DashboardService</name>
  <files>server/lib/services/dashboard_service.dart</files>
  <action>
Add these 4 public methods to DashboardService (before the private helpers section):

1. **getTrainingDays({String? period})** -> Map<String, int>
   - Returns date-string -> set-count map for the heatmap
   - SQL: `SELECT DATE(w.start_time, 'unixepoch') as workout_date, COUNT(gs.id) as set_count FROM workouts w INNER JOIN gym_sets gs ON w.id = gs.workout_id WHERE w.start_time >= ? AND gs.hidden = 0 GROUP BY workout_date ORDER BY workout_date`
   - Uses `_periodToEpoch(period)` for filtering

2. **getMuscleGroupVolumes({String? period})** -> List<Map<String, dynamic>>
   - Returns [{muscle: String, volume: double}, ...] for bar chart
   - SQL: `SELECT gs.category as muscle, SUM(gs.weight * gs.reps) as total_volume FROM gym_sets gs WHERE gs.created >= ? AND gs.hidden = 0 AND gs.category IS NOT NULL AND gs.cardio = 0 GROUP BY gs.category ORDER BY total_volume DESC`

3. **getMuscleGroupSetCounts({String? period})** -> List<Map<String, dynamic>>
   - Returns [{muscle: String, sets: int}, ...] for bar chart
   - SQL: `SELECT gs.category as muscle, COUNT(*) as set_count FROM gym_sets gs WHERE gs.created >= ? AND gs.hidden = 0 AND gs.category IS NOT NULL GROUP BY gs.category ORDER BY set_count DESC`

4. **getExerciseProgress(String exerciseName, {String metric = 'bestWeight', String? period})** -> List<Map<String, dynamic>>
   - Returns [{created: int, value: double, weight: num, reps: num, unit: String}, ...] time series
   - Metric expressions:
     - 'bestWeight': `weight`
     - 'oneRepMax': `CASE WHEN weight >= 0 THEN weight / (1.0278 - 0.0278 * reps) ELSE weight * (1.0278 - 0.0278 * reps) END`
     - 'volume': `weight * reps`
   - Groups by day (`STRFTIME('%Y-%m-%d', DATE(created, 'unixepoch', 'localtime'))`) and takes daily best via `HAVING metric = MAX(metric)`
   - Filters: `hidden = 0 AND reps > 0`, plus period via `_periodToEpoch`
   - Ordered by `created ASC`

Also extend `_periodToEpoch` to handle '3m' and '6m' periods:
- '3m': `DateTime(now.year, now.month - 3, now.day)`
- '6m': `DateTime(now.year, now.month - 6, now.day)`

All methods must return safe empty defaults when `_db == null`.
  </action>
  <verify>Search the file for all 4 new method signatures plus the extended _periodToEpoch cases. Run `rg "getTrainingDays|getMuscleGroupVolumes|getMuscleGroupSetCounts|getExerciseProgress|case '3m'|case '6m'" server/lib/services/dashboard_service.dart` to confirm all are present.</verify>
  <done>DashboardService has 13 public methods (9 existing + 4 new). _periodToEpoch handles week, month, 3m, 6m, year, all.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard routing, auth, layout shell, and overview page</name>
  <files>server/lib/middleware/auth.dart, server/bin/server.dart, server/lib/api/dashboard_pages.dart</files>
  <action>
**auth.dart:** Add dashboard route handling alongside the existing 'manage' check. Before the Bearer token block, add:
```dart
if (request.url.path.startsWith('dashboard')) {
  final key = request.url.queryParameters['key'];
  if (key != apiKey) {
    return Response.forbidden(
      '{"error": "Invalid API key"}',
      headers: {'content-type': 'application/json'},
    );
  }
  return innerHandler(request);
}
```

**server.dart:**
- Import `dashboard_pages.dart` and `dashboard_service.dart`
- Create `DashboardService(config.dataDir)` after backupService initialization
- Register these routes (all pass dashboardService and config.apiKey):
  - `GET /dashboard` -> `overviewPageHandler`
  - `GET /dashboard/exercises` -> `exercisesPageHandler`
  - `GET /dashboard/exercise/<name>` -> `exerciseDetailHandler` (name is URL-encoded exercise name)
  - `GET /dashboard/history` -> `historyPageHandler`
  - `GET /dashboard/workout/<id>` -> `workoutDetailHandler` (id is workout integer ID)

**dashboard_pages.dart:** Create new file with:

1. **dashboardShell()** function â€” shared HTML layout shell used by all pages. Parameters: `{required String title, required String activeNav, required String content, required String apiKey, String extraHead = '', String extraScripts = ''}`. Returns full HTML string.

   CSS (via CSS custom properties for dark/light theme):
   - Dark theme (default on `:root`): `--bg: #0f0f0f`, `--surface: #1a1a1a`, `--surface-elevated: #242424`, `--text: #e0e0e0`, `--text-muted: #888`, `--accent: #7C3AED`, `--accent-dim: rgba(124,58,237,0.2)`, `--accent-hover: #6D28D9`, `--border: #333`
   - Light theme (on `html.light`): `--bg: #f5f5f5`, `--surface: #ffffff`, `--surface-elevated: #f0f0f0`, `--text: #1a1a1a`, `--text-muted: #666`, `--accent: #7C3AED`, `--accent-dim: rgba(124,58,237,0.1)`, `--accent-hover: #6D28D9`, `--border: #ddd`
   - Body: `background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0;`
   - Sidebar: Fixed left, 240px wide, `background: var(--surface)`, border-right. Logo "JackedLog" at top. Nav items: Overview, Exercises, History, Backups (link to /manage?key=). Active item has `background: var(--accent-dim); color: var(--accent)`.
   - Main area: `margin-left: 240px`. Header bar with hamburger button (hidden on desktop), page title, and theme toggle icon button (sun/moon).
   - Responsive: `@media (max-width: 768px)` hides sidebar (transform: translateX(-100%)), shows hamburger, sets main margin-left: 0. Sidebar gets `.open` class via JS to slide in. Overlay behind sidebar when open.
   - Theme JS: `toggleTheme()` adds/removes `.light` class on `<html>`, persists to `localStorage`. On load, read localStorage and apply class.
   - Hamburger JS: `toggleSidebar()` toggles `.open` on sidebar and shows/hides overlay.

2. **overviewPageHandler(Request, DashboardService, BackupService, String apiKey)** -> Response
   - Open dashboard DB if not open: `if (!dashboard.isOpen) dashboard.open();`
   - If dashboard has no data, return shell with "No backup data" message.
   - Query: `getOverviewStats()`, `getTrainingDays()`, `getMuscleGroupVolumes()`, `getMuscleGroupSetCounts()`
   - Build content with:

   **Stats cards row** (4 cards in a CSS Grid row, wrap on mobile):
   - Workouts (count), Volume (formatted with K/M suffix), Streak (days), Training Time (hours:minutes formatted)
   - Each card: icon/emoji label, large number, subtle description

   **Training heatmap** (SVG, generated server-side in Dart):
   - GitHub-style grid: 7 rows (Mon-Sun), ~52 columns (weeks), scrollable horizontally if needed
   - Cell: 14x14px `<rect>` with rx="3", 3px gap between cells
   - Color intensity by set count: 0 = `var(--surface-elevated)`, <5 = `rgba(124,58,237,0.25)`, <10 = `rgba(124,58,237,0.45)`, <15 = `rgba(124,58,237,0.65)`, 15+ = `rgba(124,58,237,0.85)`
   - Month labels on top row
   - Day labels (M, W, F) on left
   - Less/More legend at bottom right
   - Walk backwards from today to fill grid cells. For each cell, look up date in trainingDays map.

   **Muscle group charts** (2 Chart.js bar charts side by side, stack on mobile):
   - Volume chart: purple bars (#7C3AED), horizontal bar chart, muscle names as Y-axis labels
   - Set count chart: teal bars (#06B6D4), same layout
   - Load Chart.js from CDN: `https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js`
   - Embed data as JSON in `<script type="application/json" id="volume-data">` and `<script type="application/json" id="sets-data">`
   - Initialize charts on DOMContentLoaded
   - Charts should have: no legend, horizontal bars (indexAxis: 'y'), border-radius 4, grid lines in `var(--border)` color, tick labels in `var(--text-muted)` color

   Use StringBuffer for building HTML in loops (heatmap cells, stats).

   **Important details:**
   - All internal links include `?key=$apiKey` parameter
   - Chart.js script tag loaded before chart initialization scripts
   - Charts use `responsive: true` and `maintainAspectRatio: false` with fixed container height
   - For Chart.js theme colors, read CSS variables via `getComputedStyle(document.documentElement).getPropertyValue('--text-muted')` in JS
  </action>
  <verify>Verify the file structure: `rg "dashboardShell|overviewPageHandler|exercisesPageHandler|exerciseDetailHandler|historyPageHandler|workoutDetailHandler" server/bin/server.dart server/lib/api/dashboard_pages.dart`. Verify auth handles dashboard: `rg "dashboard" server/lib/middleware/auth.dart`. The exercises/history/workout handlers can be stub functions that return a placeholder page using dashboardShell() -- they will be implemented in plans 02 and 03.</verify>
  <done>Dashboard infrastructure is wired: auth passes dashboard routes with ?key=, server.dart has all route registrations, dashboard_pages.dart has the shared layout shell (sidebar, hamburger, theme toggle, CSS variables) and a working overview page with stats cards, SVG heatmap, and Chart.js muscle group bar charts. Stub handlers exist for exercises, exercise detail, history, and workout detail pages.</done>
</task>

</tasks>

<verification>
1. All 4 new DashboardService query methods exist with correct signatures
2. _periodToEpoch handles week, month, 3m, 6m, year, all
3. Auth middleware allows dashboard routes with ?key= query parameter
4. server.dart imports and registers all dashboard routes
5. dashboard_pages.dart exports dashboardShell and all page handlers
6. Overview page renders stats cards, SVG heatmap, and 2 Chart.js bar charts
7. Layout has responsive sidebar/hamburger and dark/light theme toggle via CSS custom properties
8. All internal links include ?key= parameter
9. Stub handlers exist for exercises, exercise detail, history, workout detail
</verification>

<success_criteria>
- `dart analyze server/` passes with no errors
- Overview page at /dashboard?key=xxx renders complete HTML with stats, heatmap SVG, and chart.js scripts
- Theme toggle switches between dark/light via CSS custom properties
- Sidebar shows 4 nav items with active state on Overview
- Stub pages return valid HTML wrapped in dashboardShell for /dashboard/exercises, /dashboard/exercise/:name, /dashboard/history, /dashboard/workout/:id
</success_criteria>

<output>
After completion, create `.planning/phases/13-dashboard-frontend/13-01-SUMMARY.md`
</output>
