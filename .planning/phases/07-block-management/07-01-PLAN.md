---
phase: 07-block-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/fivethreeone/fivethreeone_state.dart
  - lib/fivethreeone/schemes.dart
  - lib/fivethreeone/block_creation_dialog.dart
  - lib/fivethreeone/block_overview_page.dart
  - lib/settings/settings_page.dart
autonomous: true

must_haves:
  truths:
    - "User can create a new block by entering 4 TMs and the block starts at Leader 1 Week 1"
    - "Block overview page shows 5-cycle vertical timeline with current position highlighted"
    - "User can tap Complete Week to advance to next week; past Week 3 moves to next cycle"
    - "When advancing past Leader 1, Leader 2, or Anchor, TMs auto-bump with confirmation dialog"
    - "Settings page has a 5/3/1 Block entry that opens the creation dialog"
  artifacts:
    - path: "lib/fivethreeone/fivethreeone_state.dart"
      provides: "createBlock, advanceWeek, bumpTms, needsTmBump, isBlockComplete, positionLabel"
    - path: "lib/fivethreeone/schemes.dart"
      provides: "getMainSchemeName helper function"
    - path: "lib/fivethreeone/block_creation_dialog.dart"
      provides: "Block creation form dialog with 4 TM fields"
    - path: "lib/fivethreeone/block_overview_page.dart"
      provides: "Full-page block overview with vertical timeline, Complete Week button, TM bump dialog"
    - path: "lib/settings/settings_page.dart"
      provides: "5/3/1 Block ListTile entry point"
  key_links:
    - from: "lib/fivethreeone/block_creation_dialog.dart"
      to: "lib/fivethreeone/fivethreeone_state.dart"
      via: "calls createBlock() on form submission"
      pattern: "createBlock"
    - from: "lib/fivethreeone/block_overview_page.dart"
      to: "lib/fivethreeone/fivethreeone_state.dart"
      via: "reads activeBlock, calls advanceWeek and bumpTms"
      pattern: "advanceWeek|bumpTms|activeBlock"
    - from: "lib/fivethreeone/block_overview_page.dart"
      to: "lib/fivethreeone/schemes.dart"
      via: "reads cycleNames, cycleWeeks, cycleBumpsTm, getMainSchemeName"
      pattern: "cycleNames|cycleWeeks|getMainSchemeName"
    - from: "lib/settings/settings_page.dart"
      to: "lib/fivethreeone/block_creation_dialog.dart"
      via: "showDialog opens BlockCreationDialog"
      pattern: "BlockCreationDialog"
---

<objective>
Implement block creation, state management, and the block overview page with week/cycle advancement and TM bump logic.

Purpose: This is the core of Phase 7 -- users can create a 5/3/1 block, see their position in the 11-week structure, advance through weeks/cycles, and get TM bumps at cycle boundaries. Covers BLOCK-01 through BLOCK-04.

Output: Working block creation dialog accessible from Settings, state methods for all block mutations, and a full overview page with vertical timeline and Complete Week advancement.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-block-management/07-RESEARCH.md
@.planning/phases/07-block-management/07-CONTEXT.md
@lib/fivethreeone/fivethreeone_state.dart
@lib/fivethreeone/schemes.dart
@lib/database/fivethreeone_blocks.dart
@lib/settings/settings_page.dart
@lib/widgets/training_max_editor.dart
@lib/settings/settings_state.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state action methods and scheme helper</name>
  <files>
    lib/fivethreeone/fivethreeone_state.dart
    lib/fivethreeone/schemes.dart
  </files>
  <action>
**schemes.dart** -- Add `getMainSchemeName(int cycleType)` function returning the display name for each cycle type:
- `cycleLeader1`/`cycleLeader2` -> `"5's PRO"`
- `cycleAnchor` -> `"PR Sets"`
- `cycleDeload` -> `"7th Week Deload"`
- `cycleTmTest` -> `"TM Test"`
- default -> `''`

Pattern: mirrors existing `getSupplementalName()` in same file.

**fivethreeone_state.dart** -- Add these methods and getters to `FiveThreeOneState`:

1. `Future<void> createBlock({required double squatTm, required double benchTm, required double deadliftTm, required double pressTm, required String unit})`:
   - First deactivate any existing active block: `UPDATE fiveThreeOneBlocks SET isActive = false, completed = now WHERE isActive = true`
   - Then insert new block using `FiveThreeOneBlocksCompanion.insert(created: DateTime.now(), squatTm, benchTm, deadliftTm, pressTm, unit)` -- other fields default (cycle=0, week=1, isActive=true)
   - Call `await refresh()` at end

2. `Future<void> advanceWeek()`:
   - Guard: if `_activeBlock == null` return
   - Read `cycleWeeks[block.currentCycle]` for max weeks in current cycle
   - If `block.currentWeek < maxWeeks`: increment `currentWeek` by 1
   - Else if `block.currentCycle < cycleTmTest`: set `currentCycle + 1`, `currentWeek = 1`
   - Else: block complete -- set `isActive = false`, `completed = DateTime.now()`
   - Use `db.fiveThreeOneBlocks.update()..where((b) => b.id.equals(block.id))` with `FiveThreeOneBlocksCompanion(...)` and `Value()` wrappers
   - Call `await refresh()` at end

3. `Future<void> bumpTms()`:
   - Guard: if `_activeBlock == null` return
   - Upper body bump: +2.2 (Bench, OHP/Press)
   - Lower body bump: +4.5 (Squat, Deadlift)
   - Update block row with new TM values using `Value()` wrappers
   - Call `await refresh()` at end

4. `bool get needsTmBump`:
   - Returns true when current week is at max for current cycle AND `cycleBumpsTm[currentCycle]` is true
   - This means a TM bump dialog should be shown before advancing

5. `bool get isBlockComplete`:
   - Returns true when `currentCycle == cycleTmTest` AND `currentWeek >= cycleWeeks[cycleTmTest]`

6. `String get positionLabel`:
   - Returns `'$cycleName — Week $currentWeek • $schemeName'` using `cycleNames` and `getMainSchemeName`
   - Returns `''` if no active block

Import `schemes.dart` and `'package:drift/drift.dart'` (for `Value` class) in fivethreeone_state.dart. Use `hide Column` on the drift import to avoid conflict with Flutter's Column.
  </action>
  <verify>
Verify by reading both files and confirming:
- `getMainSchemeName` exists in schemes.dart with correct switch cases
- All 6 methods/getters exist in fivethreeone_state.dart
- `createBlock` deactivates existing blocks before inserting
- `advanceWeek` handles all boundary transitions correctly (Leader1 W3 -> Leader2 W1, Deload W1 -> Anchor W1, TM Test W1 -> block complete)
- `bumpTms` uses +2.2 for bench/press and +4.5 for squat/deadlift
- `needsTmBump` checks both week boundary AND `cycleBumpsTm`
  </verify>
  <done>
FiveThreeOneState has createBlock, advanceWeek, bumpTms, needsTmBump, isBlockComplete, and positionLabel. schemes.dart has getMainSchemeName. All methods follow existing Drift update/insert patterns with Value() wrappers and refresh() calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create block creation dialog and settings entry point</name>
  <files>
    lib/fivethreeone/block_creation_dialog.dart
    lib/settings/settings_page.dart
  </files>
  <action>
**block_creation_dialog.dart** -- Create new file. Build a Dialog mirroring `TrainingMaxEditor` layout (header with primaryContainer background, scrollable content with 4 TM fields, footer with action button):

Structure:
- `BlockCreationDialog` StatefulWidget
- 4 `TextEditingController`s for Squat, Bench, Deadlift, OHP TMs
- `_unit` String initialized from `SettingsState.value.strengthUnit`
- Pre-fill TM fields by reading from `SettingsState.value`: `fivethreeoneSquatTm`, `fivethreeoneBenchTm`, `fivethreeoneDeadliftTm`, `fivethreeonePressTm` (using `toStringAsFixed(1)` if non-null)
- Validation: all 4 fields must parse as valid doubles > 0
- On "Start Block" button tap: call `context.read<FiveThreeOneState>().createBlock(...)` with parsed values and unit, then `Navigator.pop(context)`
- Header: Icon + "Start 5/3/1 Block" title + close button
- Each TM field: `TextField` with `TextInputType.numberWithOptions(decimal: true)`, suffix showing unit, label showing lift name
- Footer: info text about the 11-week block structure + `FilledButton` "Start Block"
- If there is already an active block (`context.read<FiveThreeOneState>().hasActiveBlock`), show a warning that starting a new block will end the current one

Imports: flutter/material, provider, drift (hide Column), database.dart, fivethreeone_state.dart, settings_state.dart.

Use `inputFormatters: [FilteringTextInputFormatter.allow(RegExp(r'[0-9.]'))]` for numeric-only input. Import `flutter/services.dart`.

**settings_page.dart** -- Add a "5/3/1 Block" ListTile to the settings list. Insert it between the "Workouts" and "Spotify" entries in the non-search ListView children list. Use:
```
ListTile(
  leading: const Icon(Icons.fitness_center),
  title: const Text('5/3/1 Block'),
  onTap: () {
    showDialog(
      context: context,
      builder: (context) => const BlockCreationDialog(),
    );
  },
),
```

Add import for `block_creation_dialog.dart` at top of settings_page.dart:
`import '../fivethreeone/block_creation_dialog.dart';`
  </action>
  <verify>
Verify by reading both files and confirming:
- `BlockCreationDialog` class exists with 4 TM controllers
- Settings pre-fill logic reads from SettingsState
- Validation checks all 4 fields are valid doubles
- "Start Block" calls `FiveThreeOneState.createBlock()` and pops dialog
- Settings page has the "5/3/1 Block" ListTile between "Workouts" and "Spotify"
- Import for block_creation_dialog.dart exists in settings_page.dart
  </verify>
  <done>
Block creation dialog mirrors TrainingMaxEditor pattern with 4 TM fields, pre-fills from Settings, validates input, and calls createBlock(). Settings page has entry point ListTile.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create block overview page with timeline and advancement</name>
  <files>
    lib/fivethreeone/block_overview_page.dart
  </files>
  <action>
**block_overview_page.dart** -- Create new file. Full-page Scaffold with AppBar titled "5/3/1 Block".

Navigation: pushed via `Navigator.of(context).push(MaterialPageRoute(builder: (_) => const BlockOverviewPage()))`.

**Page structure:**
- Read `FiveThreeOneState` via `context.watch<FiveThreeOneState>()`
- If no active block: show centered message "No active block" with a button to open `BlockCreationDialog`
- If active block exists: show vertical timeline + Complete Week button

**Vertical timeline (custom, NOT Flutter Stepper):**

Build from `Column` containing 5 cycle entries. Loop `for (int i = 0; i < cycleNames.length; i++)`.

**Concrete widget structure for each cycle entry:**

```dart
Widget _buildCycleEntry(int cycleIndex, int currentCycle, int currentWeek, FiveThreeOneBlock block) {
  final isCompleted = cycleIndex < currentCycle;
  final isCurrent = cycleIndex == currentCycle;
  final colorScheme = Theme.of(context).colorScheme;

  return IntrinsicHeight(
    child: Row(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        // Left: vertical line + circle indicator
        SizedBox(
          width: 40,
          child: Column(
            children: [
              if (cycleIndex > 0) // connector from previous
                Expanded(child: Container(width: 2, color: isCompleted || isCurrent ? colorScheme.primary : colorScheme.outlineVariant)),
              Container(
                width: 24, height: 24,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: isCompleted ? colorScheme.primary : isCurrent ? colorScheme.primaryContainer : colorScheme.surfaceContainerLow,
                  border: isCurrent ? Border.all(color: colorScheme.primary, width: 2) : null,
                ),
                child: isCompleted ? Icon(Icons.check, size: 14, color: colorScheme.onPrimary) : null,
              ),
              if (cycleIndex < cycleNames.length - 1) // connector to next
                Expanded(child: Container(width: 2, color: isCompleted ? colorScheme.primary : colorScheme.outlineVariant)),
            ],
          ),
        ),
        // Right: cycle card
        Expanded(
          child: Card(
            color: isCurrent ? colorScheme.primaryContainer : isCompleted ? colorScheme.surfaceContainerHighest : colorScheme.surfaceContainerLow,
            child: Padding(
              padding: const EdgeInsets.all(12),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(cycleNames[cycleIndex], style: TextStyle(fontWeight: isCurrent ? FontWeight.bold : FontWeight.normal)),
                  Text(getMainSchemeName(cycleIndex), style: Theme.of(context).textTheme.bodySmall),
                  if (isCurrent) ..._buildWeekIndicators(cycleIndex, currentWeek),
                ],
              ),
            ),
          ),
        ),
      ],
    ),
  );
}
```

**Week indicators within current cycle:**
- For each week 1..cycleWeeks[cycleIndex], show a small row with dot + "Week N"
- Color completed weeks (week < currentWeek) with primary, current week bold, future weeks muted
- Show TM values below the week indicators: "S: {squat} / B: {bench} / D: {deadlift} / P: {press}"

**Complete Week button:**
- Place as a prominent `FilledButton.icon` at the bottom of the scrollable content, below the timeline
- Label: "Complete Week" with a forward/next icon
- When block is complete (`isBlockComplete`), disable the button or show "Block Complete" text instead

**Complete Week button onPressed -- explicit async/await flow:**

```dart
onPressed: () async {
  final state = context.read<FiveThreeOneState>();
  if (state.needsTmBump) {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Bump Training Max?'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Squat: ${block.squatTm} → ${block.squatTm + 4.5} ${block.unit}'),
            Text('Bench: ${block.benchTm} → ${block.benchTm + 2.2} ${block.unit}'),
            Text('Deadlift: ${block.deadliftTm} → ${block.deadliftTm + 4.5} ${block.unit}'),
            Text('OHP: ${block.pressTm} → ${block.pressTm + 2.2} ${block.unit}'),
          ],
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text('Skip')),
          FilledButton(onPressed: () => Navigator.pop(ctx, true), child: const Text('Bump TMs')),
        ],
      ),
    );
    if (confirmed == true) {
      await state.bumpTms();
    }
  }
  await state.advanceWeek();
},
```

Use `context.read` (not `watch`) inside the callback since it is an event handler, not a build method.

**Important implementation details:**
- Use `cycleWeeks` from schemes.dart for week count per cycle (not hardcoded 3)
- Use `cycleNames` for display names
- Use `cycleBumpsTm` only indirectly via `needsTmBump` getter
- The page auto-updates because it watches `FiveThreeOneState` (ChangeNotifier)
- Wrap the timeline in `SingleChildScrollView` for scrollability
- Use `const` constructors where possible

Imports: flutter/material, provider, fivethreeone_state.dart, schemes.dart, block_creation_dialog.dart (for the "create block" button when no active block).
  </action>
  <verify>
1. Read `lib/fivethreeone/block_overview_page.dart` and confirm `BlockOverviewPage` class exists as StatelessWidget or StatefulWidget
2. Grep for `context.watch<FiveThreeOneState>` in block_overview_page.dart to confirm reactive state watching
3. Grep for `cycleNames` in block_overview_page.dart to confirm all 5 cycle entries are rendered from the cycles list
4. Grep for `primaryContainer` and `surfaceContainerHighest` in block_overview_page.dart to confirm color coding for current vs completed cycles
5. Grep for `getMainSchemeName` in block_overview_page.dart to confirm scheme names displayed in cycle entries
6. Grep for `Complete Week` or `CompleteWeek` in block_overview_page.dart to confirm button exists
7. Grep for `needsTmBump` in block_overview_page.dart to confirm TM bump check is wired in onPressed
8. Grep for `async` in block_overview_page.dart and confirm the Complete Week onPressed callback uses `async { ... await ... }` pattern
9. Grep for `showDialog` in block_overview_page.dart to confirm both the TM bump dialog and the no-active-block creation dialog exist
10. Grep for `advanceWeek` in block_overview_page.dart to confirm it is called after the bump dialog flow
  </verify>
  <done>
Block overview page shows vertical timeline with 5 color-coded cycles, expanded current cycle with week details, TM values, Complete Week button with TM bump confirmation dialog. All advancement logic wired through FiveThreeOneState.
  </done>
</task>

</tasks>

<verification>
1. Read `lib/fivethreeone/schemes.dart` and confirm `getMainSchemeName` function exists
2. Read `lib/fivethreeone/fivethreeone_state.dart` and confirm all 6 methods/getters exist with correct logic
3. Read `lib/fivethreeone/block_creation_dialog.dart` and confirm dialog structure with 4 TM fields
4. Read `lib/settings/settings_page.dart` and confirm "5/3/1 Block" ListTile exists
5. Read `lib/fivethreeone/block_overview_page.dart` and confirm timeline with 5 cycles, advancement button, TM bump dialog
6. Verify no `import 'package:flutter/widgets.dart'` conflicts with drift Column
</verification>

<success_criteria>
- BlockCreationDialog creates a new block with 4 TMs that starts at Leader 1 Week 1
- BlockOverviewPage renders 5-cycle timeline with correct color states
- Complete Week advances within cycle and across cycle boundaries
- TM bump dialog appears when crossing Leader 1, Leader 2, or Anchor boundaries (not Deload or TM Test)
- Settings page has entry point to block creation
- All state methods call refresh() and notify listeners
</success_criteria>

<output>
After completion, create `.planning/phases/07-block-management/07-01-SUMMARY.md`
</output>
