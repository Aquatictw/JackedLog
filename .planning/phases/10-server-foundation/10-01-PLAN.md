---
phase: 10-server-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/pubspec.yaml
  - server/bin/server.dart
  - server/lib/config.dart
  - server/lib/middleware/auth.dart
  - server/lib/middleware/cors.dart
  - server/lib/api/health_api.dart
autonomous: true

must_haves:
  truths:
    - "Server starts and listens on configured port"
    - "GET /api/health returns JSON with status, version, and uptime"
    - "Requests without valid Bearer token are rejected with 401/403"
    - "Health check endpoint is accessible without authentication"
    - "CORS headers are present on all responses including preflight OPTIONS"
  artifacts:
    - path: "server/pubspec.yaml"
      provides: "Dart project manifest with shelf, shelf_router, sqlite3, shelf_multipart dependencies"
      contains: "shelf"
    - path: "server/bin/server.dart"
      provides: "Server entry point with Pipeline, middleware, router, and io.serve"
      min_lines: 30
    - path: "server/lib/config.dart"
      provides: "Environment variable parsing for JACKED_API_KEY, PORT, DATA_DIR"
      contains: "JACKED_API_KEY"
    - path: "server/lib/middleware/auth.dart"
      provides: "Bearer token authentication middleware"
      exports: ["authMiddleware"]
    - path: "server/lib/middleware/cors.dart"
      provides: "CORS middleware allowing all origins"
      exports: ["corsMiddleware"]
    - path: "server/lib/api/health_api.dart"
      provides: "Health check endpoint handler"
      exports: ["healthHandler"]
  key_links:
    - from: "server/bin/server.dart"
      to: "server/lib/config.dart"
      via: "import and env var reading"
      pattern: "import.*config"
    - from: "server/bin/server.dart"
      to: "server/lib/middleware/auth.dart"
      via: "Pipeline.addMiddleware"
      pattern: "authMiddleware"
    - from: "server/bin/server.dart"
      to: "server/lib/api/health_api.dart"
      via: "router.get('/api/health')"
      pattern: "healthHandler"
---

<objective>
Create the server project scaffold with Dart package configuration, environment-based config parsing, authentication and CORS middleware, health check endpoint, and a working entry point that wires everything together via shelf Pipeline.

Purpose: Establishes the server foundation that all subsequent plans build upon — the running server, middleware chain, and routing infrastructure.
Output: A runnable Dart server at `server/` that starts, authenticates requests, and serves a health check endpoint.
</objective>

<execution_context>
@/home/aquatic/.claude/get-shit-done/workflows/execute-plan.md
@/home/aquatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-server-foundation/10-CONTEXT.md
@.planning/phases/10-server-foundation/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server project with config, middleware, and health check</name>
  <files>
    server/pubspec.yaml
    server/lib/config.dart
    server/lib/middleware/auth.dart
    server/lib/middleware/cors.dart
    server/lib/api/health_api.dart
  </files>
  <action>
    Create the `server/` directory and the following files:

    **server/pubspec.yaml:**
    - name: jackedlog_server
    - Dart SDK constraint: >=3.2.6 <4.0.0
    - Dependencies: shelf ^1.4.2, shelf_router ^1.1.4, sqlite3 ^3.1.5, shelf_multipart ^2.0.1

    **server/lib/config.dart:**
    - Class `ServerConfig` with fields: `apiKey` (String), `port` (int), `dataDir` (String)
    - Factory `ServerConfig.fromEnvironment()` that reads:
      - `JACKED_API_KEY` (required — throw if missing)
      - `PORT` (default: 8080)
      - `DATA_DIR` (default: /data)
    - Store `startTime` as `DateTime.now()` for uptime calculation

    **server/lib/middleware/auth.dart:**
    - Function `Middleware authMiddleware(String apiKey)` that:
      - Skips auth for path `api/health` (passes through)
      - For path `manage`: checks `key` query parameter against apiKey, returns 403 if invalid
      - For all other paths: reads `Authorization` header, expects `Bearer <token>`, returns 401 if missing, 403 if token != apiKey
      - All error responses are JSON with `{"error": "..."}` body and content-type application/json

    **server/lib/middleware/cors.dart:**
    - Function `Middleware corsMiddleware()` that:
      - Returns 200 with CORS headers for OPTIONS preflight requests
      - Adds CORS headers to all other responses
      - Headers: Access-Control-Allow-Origin: *, Allow-Methods: GET POST DELETE OPTIONS, Allow-Headers: Authorization Content-Type

    **server/lib/api/health_api.dart:**
    - Store server start time (accept as parameter or use a top-level variable set at startup)
    - Function `Response healthHandler(Request request)` that returns JSON:
      `{"status": "ok", "version": "1.0.0", "uptime": <seconds since start>}`
    - Content-Type: application/json
  </action>
  <verify>
    All files exist and contain the expected classes/functions. `rg "authMiddleware" server/` finds the export. `rg "healthHandler" server/` finds the export. `rg "JACKED_API_KEY" server/lib/config.dart` confirms env var reading.
  </verify>
  <done>
    Config class parses environment variables with defaults. Auth middleware rejects missing/invalid tokens. CORS middleware adds headers to all responses. Health handler returns JSON status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server entry point with Pipeline and Router</name>
  <files>
    server/bin/server.dart
  </files>
  <action>
    Create `server/bin/server.dart` as the main entry point:

    1. Import config, auth middleware, cors middleware, health_api
    2. In `main()`:
       - Parse config via `ServerConfig.fromEnvironment()`
       - Ensure data directory exists (create if not: `Directory(config.dataDir).createSync(recursive: true)`)
       - Create `Router`:
         - `GET /api/health` -> healthHandler
         - (Backup routes will be added in Plan 02)
         - (Manage route will be added in Plan 03)
       - Build handler with `Pipeline()`:
         - `.addMiddleware(logRequests())` — shelf's built-in logging
         - `.addMiddleware(corsMiddleware())`
         - `.addMiddleware(authMiddleware(config.apiKey))`
         - `.addHandler(router.call)`
       - Start server: `await io.serve(handler, '0.0.0.0', config.port)`
       - Print startup info: server version, port, data directory

    The entry point must be a clean, readable main() that wires middleware and routes. Keep it under 40 lines. Route handlers for backup API and manage page will be added by Plans 02 and 03 respectively.
  </action>
  <verify>
    `server/bin/server.dart` exists and imports all middleware and health handler. `rg "Pipeline" server/bin/server.dart` confirms middleware chain. `rg "io.serve" server/bin/server.dart` confirms server startup.
  </verify>
  <done>
    Server entry point creates Pipeline with logging, CORS, and auth middleware, registers health route, and starts listening on configured port. Data directory is created if missing.
  </done>
</task>

</tasks>

<verification>
1. `server/pubspec.yaml` lists shelf, shelf_router, sqlite3, shelf_multipart as dependencies
2. `server/lib/config.dart` reads JACKED_API_KEY (required), PORT (default 8080), DATA_DIR (default /data)
3. `server/lib/middleware/auth.dart` skips auth for health, uses query param for manage, uses Bearer token for API
4. `server/lib/middleware/cors.dart` handles OPTIONS preflight and adds CORS headers
5. `server/lib/api/health_api.dart` returns JSON with status, version, uptime
6. `server/bin/server.dart` wires Pipeline with middleware chain and starts server
</verification>

<success_criteria>
- All 6 files exist at their specified paths
- Server entry point compiles and would start if run with JACKED_API_KEY set
- Auth middleware correctly gates all endpoints except health check
- Health endpoint returns valid JSON with status, version, and uptime fields
</success_criteria>

<output>
After completion, create `.planning/phases/10-server-foundation/10-01-SUMMARY.md`
</output>
